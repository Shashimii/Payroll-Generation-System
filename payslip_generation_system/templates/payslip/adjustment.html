{% extends "includes/layout.html" %}
{% block title %}Adjustments{% endblock title %}
{% load humanize %}
{% block layout_content %}

<button class="btn btn-secondary mb-3" onclick="window.location.href='{% url 'payslip' %}'">
    <i class="fa-solid fa-arrow-left"></i>
    Back
</button>

<div class="card card-outline card-success">
  <div class="card-header">
    <h3 class="card-title mb-0">ðŸ’¼ Make Adjustments | Employee information</h3>
  </div>
    <div class="card-body">
        <div class="mb-3">
            <strong>Name:</strong> <strong>{{ employee.fullname }}</strong>
        </div>
        <div class="mb-3">
            <strong>Position:</strong> <strong>{{ employee.position }}</strong>
        </div>
        <div>
            <strong>Salary:</strong>
            <span class="text-success font-weight-bold">â‚±{{ employee.salary|floatformat:2|intcomma }}</span>
        </div>
    </div>

    {% if request.session.role|lower != 'checker' and request.session.role|lower != 'employee' and request.session.role|lower != 'accounting' %}
        <div class="card-footer text-right">
            <button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addAdjustmentModal">
                <i class="fas fa-plus-circle"></i> Add Adjustment
            </button>
            <button type="button" class="btn btn-warning mb-3" data-bs-toggle="modal" data-bs-target="#addLateModal">
                <i class="fas fa-history"></i> Add Late/Absent
            </button>
        </div>
    {% endif %}
</div>


<div class="card card-outline card-success">
  <div class="card-header">
    <h3 class="card-title mb-0">ðŸ’¼ Make Adjustments | Adjustments List</h3>
  </div>
    <div class="card-body">
        <table id="adjustmentTable" class="table table-responsive table-striped table-bordered table-sm" cellspacing="0" width="100%" >
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Details</th>
                    <th>Cutoff</th>
                    <th>Status</th>
                    <th>Remarks</th>
                    <th>Created</th>
                    <th>Action</th>
                </tr>
            </thead>
            <!-- Data -->
        </table>
    </div>
</div>

<div class="modal fade" id="addAdjustmentModal" tabindex="-1" aria-labelledby="addAdjustmentLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'adjustment_add' employee.id %}">
                {% csrf_token %}
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addAdjustmentLabel">Add Adjustment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="month" class="form-label">Month</label>
                            <select name="month" class="form-control" required>
                                <option value="">-- Select Month --</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="cutoff" class="form-label">Cutoff</label>
                            <select name="cutoff" class="form-control" required>
                                <option value="1st">1st</option>
                                <option value="2nd">2nd</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="type" class="form-label">Type</label>
                            <select name="type" class="form-control" required>
                                <option value="">-- Select Type --</option>
                                <option value="Income">Income</option>
                                <option value="Deduction">Deduction</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">Amount</label>
                            <input type="number" name="amount" step="0.01" class="form-control" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select name="status" class="form-control" {% if user_role in restricted_roles %} disabled{% endif %}>
                                {% if user_role != 'checker' %}
                                    <option value="Pending" {% if user_role in restricted_roles %} selected{% endif %}>Pending</option>
                                {% endif %}

                                {% if user_role not in restricted_roles %}
                                    <option value="Approved">Approved</option>
                                    <option value="Returned">Returned</option>
                                {% endif %}
                            </select>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="details" class="form-label">Details</label>
                            <textarea name="details" class="form-control" rows="2"></textarea>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="remarks" class="form-label">Remarks</label>
                            <textarea name="remarks" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Adjustment</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>

        </div>
    </div>
</div>

<div class="modal fade" id="addLateModal" tabindex="-1" aria-labelledby="addAdjustmentLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'adjustment_add' employee.id %}">
                {% csrf_token %}
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="addAdjustmentLabel">Add Late/Absent</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="month" class="form-label">Month</label>
                            <select name="month" class="form-control" required>
                                <option value="">-- Select Month --</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="cutoff" class="form-label">Cutoff</label>
                            <select name="cutoff" class="form-control" required>
                                <option value="1st">1st</option>
                                <option value="2nd">2nd</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" name="name" class="form-control" value="Late" readonly required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="type" class="form-label">Type</label>
                            <select name="type" class="form-control" disabled required>
                                <option value="">-- Select Type --</option>
                                <option value="Income">Income</option>
                                <option value="Deduction" selected>Deduction</option>
                            </select>
                            <input type="hidden" name="type" value="Deduction">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">Amount</label>
                            <input type="number" name="amount" step="0.01" class="form-control" readonly>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="details" class="form-label">No of Minutes</label>
                            <input type="number" name="details" step="0.01" class="form-control" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select name="status" class="form-control" {% if user_role in restricted_roles %} disabled{% endif %}>
                                {% if user_role != 'checker' %}
                                    <option value="Pending" {% if user_role in restricted_roles %} selected{% endif %}>Pending</option>
                                {% endif %}

                                {% if user_role not in restricted_roles %}
                                    <option value="Approved">Approved</option>
                                    <option value="Returned">Returned</option>
                                {% endif %}
                            </select>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="remarks" class="form-label">Remarks</label>
                            <textarea name="remarks" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Adjustment</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editReturnedModal" tabindex="-1" aria-labelledby="addAdjustmentLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addAdjustmentLabel">Add Adjustment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="month" class="form-label">Month</label>
                            <select name="month" class="form-control" required>
                                <option value="">-- Select Month --</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="cutoff" class="form-label">Cutoff</label>
                            <select name="cutoff" class="form-control" required>
                                <option value="1st">1st</option>
                                <option value="2nd">2nd</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="type" class="form-label">Type</label>
                            <select name="type" class="form-control" required>
                                <option value="">-- Select Type --</option>
                                <option value="Income">Income</option>
                                <option value="Deduction">Deduction</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">Amount</label>
                            <input type="number" name="amount" step="0.01" class="form-control" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select name="status" class="form-control" {% if user_role in restricted_roles %} disabled{% endif %}>
                                <option value="Pending" selected>Pending</option>
                            </select>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="details" class="form-label">Details</label>
                            <textarea name="details" class="form-control" rows="2"></textarea>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="remarks" class="form-label">Remarks</label>
                            <textarea name="remarks" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Adjustment</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>

        </div>
    </div>
</div>

<div class="modal fade" id="editLateModal" tabindex="-1" aria-labelledby="addAdjustmentLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'adjustment_add' employee.id %}">
                {% csrf_token %}
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="addAdjustmentLabel">Add Late/Absent</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="month" class="form-label">Month</label>
                            <select name="month" class="form-control" required>
                                <option value="">-- Select Month --</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="cutoff" class="form-label">Cutoff</label>
                            <select name="cutoff" class="form-control" required>
                                <option value="1st">1st</option>
                                <option value="2nd">2nd</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" name="name" class="form-control" value="Late" readonly required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="type" class="form-label">Type</label>
                            <select name="type" class="form-control" disabled required>
                                <option value="">-- Select Type --</option>
                                <option value="Income">Income</option>
                                <option value="Deduction" selected>Deduction</option>
                            </select>
                            <input type="hidden" name="type" value="Deduction">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">Amount</label>
                            <input type="number" name="amount" step="0.01" class="form-control" readonly>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="details" class="form-label">No of Minutes</label>
                            <input type="number" name="details" step="0.01" class="form-control" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select name="status" class="form-control" {% if user_role in restricted_roles %} disabled{% endif %}>
                                {% if user_role != 'checker' %}
                                    <option value="Pending" {% if user_role in restricted_roles %} selected{% endif %}>Pending</option>
                                {% endif %}

                                {% if user_role not in restricted_roles %}
                                    <option value="Approved">Approved</option>
                                    <option value="Returned">Returned</option>
                                {% endif %}
                            </select>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="remarks" class="form-label">Remarks</label>
                            <textarea name="remarks" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Adjustment</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
$(document).ready(function() {
    $('#adjustmentTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: "{% url 'adjustment_data' employee.id %}",
        order: [[7, 'desc']],
        columns: [
            { data: 'name' },
            { data: 'type' },
            { data: 'amount' },
            { data: 'details' },
            { data: 'cutoff_month' },
            { data: 'status' },
            { data: 'remarks' },
            { data: 'created_at' },
            { data: 'action' }
        ]
    });
});


function approveAdjustment(adjId) {
    Swal.fire({
        title: 'Approve Adjustment?',
        text: 'Are you sure you want to approve this adjustment?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, approve it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                type: 'POST',
                url: '{% url "adjustment_approve" 0 %}'.replace('0', adjId),
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire(
                            'Approved!',
                            response.message,
                            'success'
                        ).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire(
                            'Error!',
                            response.message || 'Approval failed.',
                            'error'
                        );
                    }
                },
                error: function() {
                    Swal.fire(
                        'Error!',
                        'There was an error while approving the adjustment.',
                        'error'
                    );
                }
            });
        }
    });
}

function creditAdjustment(adjId) {
    Swal.fire({
        title: 'Credit Adjustment?',
        text: 'Are you sure you want to credit this adjustment?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, credit it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                type: 'POST',
                url: '{% url "adjustment_credit" 0 %}'.replace('0', adjId),
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire(
                            'Credited!',
                            response.message,
                            'success'
                        ).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire(
                            'Error!',
                            response.message || 'Crediting failed.',
                            'error'
                        );
                    }
                },
                error: function() {
                    Swal.fire(
                        'Error!',
                        'There was an error while credting the adjustment.',
                        'error'
                    );
                }
            });
        }
    });
}

function returnAdjustment(adjId) {
    Swal.fire({
        title: 'Return Adjustment?',
        text: 'Are you sure you want to return this adjustment?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#FF0000',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, return it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                type: 'POST',
                url: '{% url "adjustment_return" 0 %}'.replace('0', adjId),
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire(
                            'Returned!',
                            response.message,
                            'success'
                        ).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire(
                            'Error!',
                            response.message || 'Return failed.',
                            'error'
                        );
                    }
                },
                error: function() {
                    Swal.fire(
                        'Error!',
                        'There was an error while returning the adjustment.',
                        'error'
                    );
                }
            });
        }
    });
}

function editAdjustment(button) {
  // Row data from button
  const id = button.getAttribute('data-id');
  const month = button.getAttribute('data-month');
  const cutoff = button.getAttribute('data-cutoff');
  const name = button.getAttribute('data-name');
  const type = button.getAttribute('data-type');
  const amount = button.getAttribute('data-amount');
  const details = button.getAttribute('data-details');
  const remarks = button.getAttribute('data-remarks');
  const employee_id = button.getAttribute('data-employee_id');

  const modal = document.getElementById('editReturnedModal');

  // Set form values
  modal.querySelector('select[name="month"]').value = month;
  modal.querySelector('select[name="cutoff"]').value = cutoff;
  modal.querySelector('input[name="name"]').value = name;
  modal.querySelector('select[name="type"]').value = type;
  modal.querySelector('input[name="amount"]').value = amount;
  modal.querySelector('textarea[name="details"]').value = details;
  modal.querySelector('textarea[name="remarks"]').value = remarks;

  // Update form action URL if needed
  const form = modal.querySelector('form');
  form.action = `/payslip/adjustment/edit/${employee_id}/${id}/`;

  // Show the modal using Bootstrap's Modal API
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}

function editAdjustmentLate(button) {
  // Row data from button
  const id = button.getAttribute('data-id');
  const month = button.getAttribute('data-month');
  const cutoff = button.getAttribute('data-cutoff');
  const name = button.getAttribute('data-name');
  const type = button.getAttribute('data-type');
  const amount = button.getAttribute('data-amount');
  const details = button.getAttribute('data-details');
  const remarks = button.getAttribute('data-remarks');
  const employee_id = button.getAttribute('data-employee_id');

  const modal = document.getElementById('editLateModal');

  // Set form values
  modal.querySelector('select[name="month"]').value = month;
  modal.querySelector('select[name="cutoff"]').value = cutoff;
  modal.querySelector('input[name="name"]').value = name;
  modal.querySelector('select[name="type"]').value = type;
  modal.querySelector('input[name="amount"]').value = amount;
  modal.querySelector('input[name="details"]').value = details;
  modal.querySelector('textarea[name="remarks"]').value = remarks;

  // Update form action URL if needed
  const form = modal.querySelector('form');
  form.action = `/payslip/adjustment/edit/${employee_id}/${id}/`;

  // Show the modal using Bootstrap's Modal API
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}

{% comment %} function archiveAdjustment(adjId) {
    Swal.fire({
        title: 'Archive Adjustment?',
        text: 'Are you sure you want to archive this adjustment?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#0055FF',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, archive it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                type: 'POST',
                url: '{% url "adjustment_archive" 0 %}'.replace('0', adjId),
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire(
                            'Archived!',
                            response.message,
                            'success'
                        ).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire(
                            'Error!',
                            response.message || 'Archive failed.',
                            'error'
                        );
                    }
                },
                error: function() {
                    Swal.fire(
                        'Error!',
                        'There was an error while archiving the adjustment.',
                        'error'
                    );
                }
            });
        }
    });
}

function unarchiveAdjustment(adjId) {
    Swal.fire({
        title: 'Unarchive Adjustment?',
        text: 'Are you sure you want to unarchive this adjustment?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#FF9900',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, archive it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                type: 'POST',
                url: '{% url "adjustment_unarchive" 0 %}'.replace('0', adjId),
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire(
                            'Unarchived!',
                            response.message,
                            'success'
                        ).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire(
                            'Error!',
                            response.message || 'Unarchive failed.',
                            'error'
                        );
                    }
                },
                error: function() {
                    Swal.fire(
                        'Error!',
                        'There was an error while unarchiving the adjustment.',
                        'error'
                    );
                }
            });
        }
    });
} {% endcomment %}


</script>
{% endblock %}