{% extends "includes/app.html" %}
{% load static %}  
{% block title %}Login{% endblock title %}
{% block app_content %}
<body>
  <div class="login-wrapper">
    <div class="container">
      <div class="row">
        <img id="bg" src="{% static 'assets/background.jpg' %}" alt="bg" />
        <div class="container">
          <!-- Image Section -->
          <div class="image-container">
            <img src="{% static 'assets/tree.jpg' %}" alt="Watch Me First" style="max-width: 100%; height: auto;">
          </div>
          <!-- Login Form Section -->
          <div class="form-container">
            <div class="logo-container" style='text-align:center'>
              <img src="{% static 'assets/denr-logo.png' %}" width='150px' height='150px' alt="Logo" class="brand-image" />
            </div>
            <p style="text-align: center; color: green">Department of Environment and Natural Resources<br><span style="color: black">National Capital Region</span></p>
            <h4 style="align-self:center; text-align:center">Payslip Generation System<br>(PAYGES)</h4>
      
            <input type="text" name="loginUsername" id="loginUsername" class="login-field" placeholder="Username" required>
            <input type="password" name="loginPassword" id="loginPassword" class="login-field" placeholder="Password" required>

            <!-- Show/Hide Password Toggle -->
            <div class="show-password">
              <input type="checkbox" id="showPassword" onclick="togglePasswordVisibility()">
              <label for="showPassword">Show Password</label>
            </div>
            
            <button type="submit" class="button" id="loginBtn">Login</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

<style>

  @media (max-width: 768px) {
    .image-container {
      display: none;
    }
    
    .brand-image {
      width: 100px;
      height: 100px;
    }

    .logo-container {
      margin-bottom: 1rem;
    }
  }

</style>

<script>
  function togglePasswordVisibility() {
    var passwordField = document.getElementById('loginPassword'); // Get the password input field
    var showPasswordCheckbox = document.getElementById('showPassword'); // Get the checkbox
    // Check if the checkbox is checked
    if (showPasswordCheckbox.checked) {
      passwordField.type = 'text'; // Change input type to 'text' to show the password
    } else {
      passwordField.type = 'password'; // Change input type back to 'password' to hide the password
    }
  }

  $(document).on('click', '#loginBtn', function() {
    var username = $('#loginUsername').val();
    var password = $('#loginPassword').val();

    // Remove client-side validation since backend now handles it
    $.ajax({
      type: "POST",
      url: "{% url 'login' %}",
      data: {
        username: username,
        password: password,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(response) {
        if (response.success) {
          Swal.fire({
              icon: "success",
              title: "Success",
              text: response.message,
            }).then(function() {
              window.location.href = response.redirect_url;
          });
        } else {
          // Handle different error types with appropriate styling
          var icon = "error";
          var title = "Authentication Failed";
          var confirmButtonColor = "#d33";
          
          if (response.error_type === 'empty_username') {
            icon = "info";
            title = "Username Required";
            confirmButtonColor = "#17a2b8";
            $('#loginUsername').focus();
          } else if (response.error_type === 'empty_password') {
            icon = "info";
            title = "Password Required";
            confirmButtonColor = "#17a2b8";
            $('#loginPassword').focus();
          } else if (response.error_type === 'username_not_found') {
            icon = "warning";
            title = "Username Not Found";
            confirmButtonColor = "#f39c12";
            // Clear username field for username not found errors
            $('#loginUsername').val('').focus();
          } else if (response.error_type === 'incorrect_password') {
            icon = "error";
            title = "Incorrect Password";
            confirmButtonColor = "#e74c3c";
            // Clear password field for incorrect password errors
            $('#loginPassword').val('').focus();
          }
          
          Swal.fire({
            title: title,
            text: response.message,
            icon: icon,
            confirmButtonColor: confirmButtonColor,
            confirmButtonText: "Try Again",
            footer: response.error_type === 'username_not_found' ? 
              '<small>Tip: Make sure you\'re using the correct username format</small>' : 
              response.error_type === 'incorrect_password' ?
              '<small>Tip: Check your password and make sure Caps Lock is off</small>' :
              '<small>Please fill in all required fields</small>'
          });
        }
      },
      error: function(xhr, status, error) {
        Swal.fire({
          title: "System Error",
          text: "There was an error while processing your request. Please try again later.",
          icon: "error",
          confirmButtonColor: "#d33",
        });
      }
    });
  });

  $(document).on('keydown', '#loginUsername, #loginPassword', function(event) {
    if (event.keyCode === 13) {  // Enter key code is 13
      event.preventDefault();  // Prevent the default action (form submission)
      $('#loginBtn').click();  // Trigger the click event for the login button
    }
  });

  {% if error %}
    Swal.fire({
      title: "Authentication Required",
      text: "{{ error }}",
      icon: "warning",
      confirmButtonColor: "#3085d6"
    });
    window.history.replaceState(null, "", "/");
  {% endif %}
</script>
{% endblock %}