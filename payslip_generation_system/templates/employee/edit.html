{% extends "includes/layout.html" %}
{% block title %}Dashboard{% endblock title %}
{% block layout_content %}

<button class="btn btn-secondary mb-3" onclick="window.location.href='{% url 'payslip' %}'">
    <i class="fa-solid fa-arrow-left"></i>
    Back
</button>

<form action="{% url 'employee_update' employee.id %}" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="card card-success">
        <div class="card-header">
            <h3 class="card-title">Edit Employee Profile Form | Personal Info</h3>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="fullname">Full Name</label>
                        <input type="text" class="form-control" name="fullname" id="fullname" placeholder="Enter full name" value="{{ employee.fullname }}" required>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="birthdate">Birthdate</label>
                        <input type="date" class="form-control" name="birthdate" id="birthdate" placeholder="Enter birthdate" value="{{ employee.birthdate|date:'Y-m-d' }}" required>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="address">Permanent Address</label>
                        <input type="text" class="form-control" name="address" id="address" placeholder="Enter address" value="{{ employee.address }}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="contact">Contact Number</label>
                        <input type="text" class="form-control" name="contact" id="contact" placeholder="Enter contact number" value="{{ employee.contact }}">
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="education">Educational Attainment</label>
                        <select class="form-control" name="education" id="education" required>
                            <option value="" disabled selected> Select </option>
                            <option value="High School" {% if employee.education == "High School" %}selected{% endif %}>High School</option>
                            <option value="Vocational" {% if employee.education == "Vocational" %}selected{% endif %}>Vocational</option>
                            <option value="Post Graduate" {% if employee.education == "Post Graduate" %}selected{% endif %}>Post Graduate</option>
                            <option value="College" {% if employee.education == "College" %}selected{% endif %}>College</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select class="form-control" name="gender" id="gender" required>
                            <option value="" disabled selected> Select </option>
                            <option value="Male" {% if employee.gender == "Male" %}selected{% endif %}>Male</option>
                            <option value="Female" {% if employee.gender == "Female" %}selected{% endif %}>Female</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card card-success">
        <div class="card-header">
            <h3 class="card-title">Edit Employee Profile | Employment Details</h3>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="employee_number">Employee Number</label>
                        <input type="text" class="form-control" name="employee_number" id="employee_number" placeholder="Enter employee number" value="{{ employee.employee_number }}" required>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="position">Position</label>
                        <input type="text" class="form-control" name="position" id="position" placeholder="Enter position" value="{{ employee.position }}" required>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="date_hired">Date Hired</label>
                        <input type="date" class="form-control" name="date_hired" id="date_hired" placeholder="Enter date_hired" value="{{ employee.date_hired|date:'Y-m-d' }}">
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="division">Division</label>
                        <select class="form-control" name="division" id="division" required>
                            <option value="" disabled {% if not employee.division %}selected{% endif %}> Select </option>
                            {% for division in divisions %}
                                <option value="{{ division.0 }}" {% if division.0 == employee.division_id %}selected{% endif %}>{{ division.3 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="section">Section</label>
                        <select class="form-control" name="section" id="section" required>
                            <option value="" disabled selected> Select </option>

                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card card-success">
        <div class="card-header">
            <h3 class="card-title">Edit Employee Profile | Employee Salary Details</h3>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="fund_source">Fund Source</label>
                        <select class="form-control" name="fund_source" id="fund_source" required>
                            <option value="" disabled selected> Select </option>
                            <option value="regular" {% if employee.fund_source == "regular" %}selected{% endif %}>Regular</option>
                            <option value="prcmo" {% if employee.fund_source == "prcmo" %}selected{% endif %}>PRCMO</option>
                            <option value="manila_bay" {% if employee.fund_source == "manila_bay" %}selected{% endif %}>Manila Bay</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="salary">Salary (‚Ç±)</label>
                        <input type="number" class="form-control" id="salary" name="salary" min="0" step="0.01" placeholder="Employee Salary" value="{{ employee.salary }}" required>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="tax_declaration">Tax Declared ?</label>
                        <select class="form-control" name="tax_declaration" id="tax_declaration" required>
                            <option value="" selected disabled> Select </option>
                            <option value="yes" {% if employee.tax_declaration == "yes" %}selected{% endif %}>Yes</option>
                            <option value="no" {% if employee.tax_declaration == "no" %}selected{% endif %}>No</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <label for="eligibility">CSC Eligibility</label>
                        <select class="form-control" name="eligibility" id="eligibility" required>
                            <option value="" selected disabled> Select </option>
                            <option value="yes" {% if employee.eligibility == "yes" %}selected{% endif %}>Yes</option>
                            <option value="no" {% if employee.eligibility == "no" %}selected{% endif %}>No</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="attachments" class="form-label font-weight-bold">Add New Attachments (optional)</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="attachments" name="attachments" multiple>
                            <label class="custom-file-label" for="attachments" id="fileLabel">üìÅ Upload Files</label>
                        </div>
                        <small id="fileNames" class="form-text text-muted">No files selected</small>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="card card-success">
        <div class="card-header">
            <h3 class="card-title">Edit Employee Profile | Existing Attachments</h3>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>File Name</th>
                                        <th style="width: 80px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for attachment in attachments %}
                                    <tr id="attachment-row-{{ attachment.id }}">
                                        <td>
                                            <a href="{{ attachment.file.url }}" target="_blank">
                                                {{ attachment.file.name|cut:"employee_attachments/" }}
                                            </a>
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="removeAttachment({{ attachment.id }})" title="Remove Attachment">
                                                &times;
                                            </button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" class="text-center">No attachments found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-end">
            <a href="{% url 'employee' %}" class="btn btn-secondary mr-2">Cancel</a>
            <button type="submit" class="btn btn-success">Edit Employee Profile</button>
        </div>
    </div>
</form>


<script>
// Section
document.addEventListener('DOMContentLoaded', function () {
    var divisionSelect = document.getElementById('division');
    var sectionSelect = document.getElementById('section');
    var currentSectionId = "{{ employee.section|default:'' }}";

    function populateSections() {
        var selectedDivisionId = divisionSelect.value;

        sectionSelect.innerHTML = '<option value="">Select</option>';

        {% for section in sections %}
            var divisionId = "{{ section.1 }}";
            var sectionId = "{{ section.0 }}";
            var sectionName = "{{ section.3 }}";

            if (divisionId === selectedDivisionId) {
                var opt = document.createElement('option');
                opt.value = sectionId;
                opt.text = sectionName;

                // Select Current Section
                if (sectionId === currentSectionId) {
                    opt.selected = true;
                }

                sectionSelect.appendChild(opt);
            }
        {% endfor %}
    }

    divisionSelect.addEventListener('change', populateSections);

    if (divisionSelect.value) {
        populateSections();
    }
});

// Attachment Input Field
document.querySelector('#attachments').addEventListener('change', function(e) {
    const input = e.target;
    const label = document.getElementById('fileLabel');
    const fileNames = document.getElementById('fileNames');

    const files = input.files;
    if (files.length === 0) {
        label.innerText = 'üìÅ Upload Files';
        fileNames.innerText = 'No files selected';
    } else if (files.length === 1) {
        label.innerText = files[0].name;
        fileNames.innerText = files[0].name;
    } else {
        label.innerText = `${files.length} files selected`;
        let names = Array.from(files).map(file => file.name).join(', ');
        fileNames.innerText = names;
    }
});

// Attachment Remove
function removeAttachment(attachmentId) {
    if (confirm("Are you sure you want to delete this attachment?")) {
        fetch("{% url 'employee_attachment_delete' 0 %}".replace('0', attachmentId), {
            method: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("attachment-row-" + attachmentId).remove();
            } else {
                alert(data.message);
            }
        });
    }
}
</script>

{% endblock %}