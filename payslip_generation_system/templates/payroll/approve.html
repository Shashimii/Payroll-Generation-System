{% extends "includes/layout.html" %}
{% block title %}Payroll{% endblock title %}
{% block layout_content %}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
            <!-- Left side: Heading -->
            <h3 class="mb-0">
                <i class="fas fa-exclamation-circle text-warning"></i> 
                Approved Payrolls
            </h3>

            <!-- Right side: Search bar -->
            <div class="position-relative mt-2 mt-md-0" style="max-width: 300px; flex: 1 1 auto;">
                <input 
                type="text" 
                id="batchSearch" 
                class="form-control ps-5" 
                placeholder="Search batches, office..."
                aria-label="Search batches office"
                >
                <!-- Search Icon -->
                <i class="fas fa-search text-muted search-icon"></i>
            </div>
        </div>
        <ul class="list-group mt-3" id="pendingBatchList">
            <li class="list-group-item text-center text-muted">Loading...</li>
        </ul>
    </div>
</div>

<button id="approveBtn" class="btn btn-success floating-approve-btn" style="display:none;">
    Approve Selected
</button>

<script>
$(document).ready(function () {
    function fetchApprovedBatches(search = "") {
        $.ajax({
            url: '/payroll/approve_data',
            method: 'GET',
            data: { search: search }, // pass search query
            success: function (response) {
                const list = $('#pendingBatchList');
                list.empty();

                if (!response.approved_batches || response.approved_batches.length === 0) {
                    list.append('<li class="list-group-item text-center text-muted">No Approved Payroll Batches.</li>');
                    return;
                }

                // Loop through the approved_batches list
                response.approved_batches.forEach(function (batch) {
                    list.append(`
                        <li 
                            class="list-group-item d-flex justify-content-between align-items-center pending-batch-item"
                            data-batch="${batch.batch_number}"
                            data-assigned-office="${batch.batch_assigned_office || ''}"
                            data-month="${batch.month || ''}"
                            data-cutoff="${batch.cutoff || ''}"
                            data-year="${batch.cutoff_year || ''}"
                        >
                            <div class="d-flex align-items-center flex-grow-1">
                                <label class="form-check-label ms-2 batch-text flex-grow-1" 
                                    for="batch-${batch.batch_number}-${batch.cutoff}-${batch.month}-${batch.cutoff_year}">
                                    <strong>${batch.batch_name}</strong><br>
                                    <small class="text-muted">${batch.formatted_office_name || 'N/A'}</small>
                                </label>
                            </div>
                            <div style="display:flex; align-items:center; gap:1rem;">
                                <span class="badge bg-success text-white">Approved</span>
                                <div class="form-check" style="display:flex; justify-content:center; align-items:center;">
                                    <input 
                                        type="checkbox" 
                                        class="form-check-input batch-checkbox"
                                        id="batch-${batch.batch_number}-${batch.cutoff}-${batch.month}-${batch.cutoff_year}"
                                    >
                                </div>
                            </div>
                        </li>
                    `);
                });

                $('#approveBtn').hide();
            },
            error: function () {
                $('#pendingBatchList').html('<li class="list-group-item text-center text-danger">Error loading data.</li>');
            }
        });
    }

    // Initial load
    fetchApprovedBatches();

    // Search input with debounce
    let searchTimeout;
    $('#batchSearch').on('keyup', function () {
        clearTimeout(searchTimeout);
        const searchValue = $(this).val();
        searchTimeout = setTimeout(() => {
            fetchApprovedBatches(searchValue);
        }, 300);
    });
});

$('#pendingBatchList').on('click', '.batch-checkbox', function (e) {
    e.stopPropagation();
});

$('#pendingBatchList').on('click', '.pending-batch-item', function () {
    const cutoff = $(this).data('cutoff');
    const month = $(this).data('month');
    const year = $(this).data('year');
    const batch = $(this).data('batch');
    const assignedOffice = $(this).data('assigned-office');

    const url = `/payroll/approve_show?cutoff=${cutoff}&cutoff_month=${month}&cutoff_year=${year}&batch_number=${batch}&assigned_office=${assignedOffice}`;
    window.location.href = url;
});

$('#pendingBatchList').on('click', '.office-approval-item', function () {
    const assignedOffice = $(this).data('assigned-office');
    const officeName = $(this).find('.batch-text small').text();
    
    // Check if user is accounting role (cashier)
    const userRole = '{{ user_role }}'; // This will be populated by Django template
    
    if (userRole === 'accounting') {
        // Show SweetAlert2 confirmation for accounting role
        Swal.fire({
            title: 'Confirm Action',
            text: `Allow the Generation of payslip for ${officeName}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Allow Generation',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading state
                Swal.fire({
                    title: 'Processing...',
                    text: 'Updating adjustment statuses...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Make AJAX call to update status
                $.ajax({
                    url: '/payroll/approve_office_to_credited',
                    method: 'POST',
                    data: {
                        assigned_office: assignedOffice
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                title: 'Success!',
                                text: response.message,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                // Reload the page to refresh the data
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error!',
                                text: response.message,
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = 'An error occurred while processing the request.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        Swal.fire({
                            title: 'Error!',
                            text: errorMessage,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            }
        });
    } else {
        // For other roles, redirect to approve_show with office filter
        const url = `/payroll/approve_show?assigned_office=${assignedOffice}`;
        window.location.href = url;
    }
});

function approveSelectedBatches() {
    const selectedBatches = [];

    // Loop through checked checkboxes
    document.querySelectorAll('.batch-checkbox:checked').forEach(checkbox => {
        const item = checkbox.closest('.pending-batch-item');
        selectedBatches.push({
            batch_number: item.dataset.batch,
            month: item.dataset.month,
            cutoff: item.dataset.cutoff,
            cutoff_year: item.dataset.year
        });
    });

    if (selectedBatches.length === 0) {
        alert('Please select at least one batch.');
        return;
    }

    $.ajax({
        url: '{% url "payroll_release_multiple_batch" %}',
        method: 'POST',
        contentType: 'application/json',
        dataType: 'json', // Force jQuery to parse as JSON
        data: JSON.stringify({
            batches: selectedBatches,
            status: 'Approved'
        }),
        success: function(response) {
            Swal.fire({
                title: 'Success!',
                text: `Payrolls Approved Successfully`,
                icon: 'success',
                confirmButtonColor: '#4caf50'
            }).then(() => {
                location.reload();
            });
        },
        error: function(xhr) {
            let errorMessage = 'An error occurred while processing the request.';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            }
            Swal.fire({
                title: 'Error!',
                text: errorMessage,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    });

}

// Show/Hide button based on checkbox selection
$('#pendingBatchList').on('change', '.batch-checkbox', function () {
    const checkedCount = $('.batch-checkbox:checked').length;
    if (checkedCount > 0) {
        $('#approveBtn').fadeIn();
    } else {
        $('#approveBtn').fadeOut();
    }
});

// Button click handler
$('#approveBtn').on('click', function () {
    approveSelectedBatches();
});


</script>

<style>
.list-group-item {
    border: 1px solid #dee2e6 !important; 
    border-radius: 8px !important;     
    margin-bottom: 8px;                  
    padding: 12px 16px;
    background-color: #fff;
    transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
}

.list-group-item:first-child,
.list-group-item:last-child {
    border-radius: 8px !important; 
}

.pending-batch-item:hover {
    background-color: #4caf50 !important;
    color: #fff !important;
    border: 1px solid #4caf50 !important; 
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); 
    cursor: pointer;
}

.pending-batch-item:hover .batch-text span,
.pending-batch-item:hover .batch-text strong,
.pending-batch-item:hover .batch-text small {
    color: #fff !important;
}

.pending-batch-item:hover .badge {
    background-color: #fff !important;   
    color: #4caf50 !important;           
    border: 1px solid #fff !important;
}

.search-icon {
    position: absolute;
    top: 50%;
    left: 14px;             
    transform: translateY(-50%);
    font-size: 0.9rem;
    pointer-events: none;    
}

#batchSearch {
    padding-left: 2.2rem; 
}

.form-check-input {
  width: 1.2rem;
  height: 1.2rem;
  cursor: pointer;
}

.form-check-label {
  cursor: pointer;
}

.floating-approve-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    font-size: 1rem;
    z-index: 9999;
    box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
    border-radius: 50px;
}

</style>

{% endblock %}
