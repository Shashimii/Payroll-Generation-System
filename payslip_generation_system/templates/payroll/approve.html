{% extends "includes/layout.html" %}
{% block title %}Payroll{% endblock title %}
{% block layout_content %}

<div class="row">
    <div class="col-12">
        <h3><i class="fas fa-exclamation-circle text-warning"></i> Approved Payrolls</h3>
        <ul class="list-group mt-3" id="pendingBatchList">
            <li class="list-group-item text-center text-muted">Loading...</li>
        </ul>
    </div>
</div>

<script>
$(document).ready(function () {
    $.ajax({
        url: '/payroll/approve_data',
        method: 'GET',
        success: function (response) {
            const list = $('#pendingBatchList');
            list.empty();

            if (!response.approved_batches || response.approved_batches.length === 0) {
                list.append('<li class="list-group-item text-center text-muted">No Approved Payroll Batches.</li>');
                return;
            }

            // Loop through the approved_batches list
            response.approved_batches.forEach(function (batch) {
                list.append(`
                    <li 
                        class="list-group-item d-flex justify-content-between align-items-center pending-batch-item"
                        data-batch="${batch.batch_number}"
                        data-assigned-office="${batch.batch_assigned_office || ''}"
                        data-month="${batch.month || ''}"
                        data-cutoff="${batch.cutoff || ''}"
                        data-year="${batch.cutoff_year || ''}"
                    >
                        <div class="batch-text">
                            <strong>${batch.batch_name}</strong><br>
                            <small class="text-muted">${batch.formatted_office_name || 'N/A'}</small>
                        </div>
                        <span class="badge bg-success text-white">Approved</span>
                    </li>
                `);
            });
        },
        error: function () {
            $('#pendingBatchList').html('<li class="list-group-item text-center text-danger">Error loading data.</li>');
        }
    });
});

$('#pendingBatchList').on('click', '.pending-batch-item', function () {
    const cutoff = $(this).data('cutoff');
    const month = $(this).data('month');
    const year = $(this).data('year');
    const batch = $(this).data('batch');
    const assignedOffice = $(this).data('assigned-office');

    const url = `/payroll/approve_show?cutoff=${cutoff}&cutoff_month=${month}&cutoff_year=${year}&batch_number=${batch}&assigned_office=${assignedOffice}`;
    window.location.href = url;
});

$('#pendingBatchList').on('click', '.office-approval-item', function () {
    const assignedOffice = $(this).data('assigned-office');
    const officeName = $(this).find('.batch-text small').text();
    
    // Check if user is accounting role (cashier)
    const userRole = '{{ user_role }}'; // This will be populated by Django template
    
    if (userRole === 'accounting') {
        // Show SweetAlert2 confirmation for accounting role
        Swal.fire({
            title: 'Confirm Action',
            text: `Allow the Generation of payslip for ${officeName}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Allow Generation',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading state
                Swal.fire({
                    title: 'Processing...',
                    text: 'Updating adjustment statuses...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Make AJAX call to update status
                $.ajax({
                    url: '/payroll/approve_office_to_credited',
                    method: 'POST',
                    data: {
                        assigned_office: assignedOffice
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                title: 'Success!',
                                text: response.message,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                // Reload the page to refresh the data
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Error!',
                                text: response.message,
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = 'An error occurred while processing the request.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        Swal.fire({
                            title: 'Error!',
                            text: errorMessage,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            }
        });
    } else {
        // For other roles, redirect to approve_show with office filter
        const url = `/payroll/approve_show?assigned_office=${assignedOffice}`;
        window.location.href = url;
    }
});
</script>

<style>
  .list-group-item {
    border-bottom: 1px solid #dee2e6;
    transition: background-color 0.2s, color 0.2s;
  }

  .pending-batch-item:hover,
  .office-approval-item:hover {
    background-color: #4caf50 !important;
    color: white !important;
  }

  .pending-batch-item:hover .batch-text strong,
  .pending-batch-item:hover .batch-text small,
  .office-approval-item:hover .batch-text strong,
  .office-approval-item:hover .batch-text small {
    color: white !important;
  }

  .list-group-item:last-child {
    border-bottom: none;
  }
</style>

{% endblock %}
