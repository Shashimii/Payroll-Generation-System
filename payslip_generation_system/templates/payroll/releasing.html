{% extends "includes/layout.html" %}
{% block title %}Payroll{% endblock title %}
{% block layout_content %}
    <button class="btn btn-secondary mb-3" onclick="window.location.href='{% url 'payroll_approved_list' %}'">
        <i class="fa-solid fa-arrow-left"></i>
        Back
    </button>


<h2 id="payrollTitle">General Payroll DENR NCR</h2>
<h4>{{ cutoff_month }} {{ cutoff }} Cutoff {{ cutoff_year }}{% if batch_name %} — {{ batch_name }}{% else %} — Batch {{ batch_number }}{% endif %}</h4>
<div id="payrollRemarkContainer" class="mb-3"></div>

<table class="table table-striped table-bordered mt-3 text-sm">
    <thead class="table-dark text-center align-middle">
        <tr>
            <th>Seq No.</th>
            <th>Full Name</th>
            <th>Position</th>
        </tr>
        </thead>
        <tbody id="employeeTableBody">
        <tr>
            <td colspan="11" class="text-center text-muted">Loading...</td>
        </tr>
    </tbody>
</table>

<input type="hidden" id="cutoff" name="cutoff">
<input type="hidden" id="cutoff_month" name="cutoff_month">
<input type="hidden" id="cutoff_year" name="cutoff_year">
<input type="hidden" id="batch_number" name="batch_number">

<button id="releasePayslipBtn" class="btn btn-success btn-block">Release Employees Payslip</button>

<script>
$(document).ready(function () {
    $.ajax({
            url: '{% url "payroll_batch_data" %}',
            method: 'GET',
            data: {
            batch_number: '{{ batch_number }}',
            batch_name: '{{ batch_name }}',
            cutoff: '{{ cutoff }}',
            cutoff_month: '{{ cutoff_month }}',
            cutoff_year: '{{ cutoff_year }}',
            assigned_office: '{{ assigned_office }}'
        },
        success: function (response) {
        $('#cutoff').val(response.cutoff);
        $('#cutoff_month').val(response.cutoff_month);
        $('#cutoff_year').val(response.cutoff_year);
        $('#batch_number').val(response.batch_number);

        // Update payroll title
        $('#payrollTitle').text(response.payroll_title || 'General Payroll DENR NCR');

         $('h4').html(`${response.cutoff_month} ${response.cutoff} Cutoff ${response.cutoff_year} — ${response.batch_name || 'Batch ' + response.batch_number}`);

        // Display approval status or remarks
        if (response.remark) {
            $('#payrollRemarkContainer').html(`
                <div class="alert alert-warning" role="alert">
                    <strong>Returned Remark:</strong> ${response.remark}
                </div>
            `);
        } else if (response.approval_status) {
            $('#payrollRemarkContainer').html(`
                <div class="alert alert-success" role="alert">
                    <strong>Status:</strong> ${response.approval_status}
                </div>
            `);
        } else {
            $('#payrollRemarkContainer').empty();
        }

        const tbody = $('#employeeTableBody');
        tbody.empty();
            if (response.employees.length > 0) {
                response.employees.forEach((emp, i) => {
                tbody.append(`
                    <tr>
                    <td>${i + 1}</td>
                    <td>${emp.fullname}</td>
                    <td>${emp.position}</td>
                    </tr>
                `);
                });
            } else {
                tbody.append('<tr><td colspan="5" class="text-center text-muted">No employees found.</td></tr>');
            }
        },
        error: function () {
            $('#employeeTableBody').html('<tr><td colspan="5" class="text-danger text-center">Failed to load data.</td></tr>');
        }
    });
});

$('#releasePayslipBtn').click(function () {
    $.ajax({
        url: '{% url "payroll_release" %}',
        method: 'POST',
        data: {
            cutoff: $('#cutoff').val(),
            cutoff_month: $('#cutoff_month').val(),
            cutoff_year: $('#cutoff_year').val(),
            batch_number: $('#batch_number').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}'  // required for POST
        },
        success: function (res) {
            if (res.status === 'OK') {
                Swal.fire({
                    icon: 'success',
                    title: 'Approved!',
                    text: 'Payslip Released successfully!',
                    confirmButtonColor: '#28a745' 
                }).then(() => {
                    location.href = "{% url 'payroll_approved_list' %}";
                });
            } else {
                alert('Failed to approve payroll.');
            }
        },
        error: function () {
            alert('Server error.');
        }
    });
});
</script>


<style>
table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

thead {
    background-color: #f1f1f1;
    font-weight: bold;
}

th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
    font-weight:700;
}


.table td, .table th {
    vertical-align: middle;
}

    .table td:nth-child(4),
    .table td:nth-child(5),
    .table td:nth-child(6),
    .table td:nth-child(7),
    .table td:nth-child(8),
    .table td:nth-child(9),
    .table td:nth-child(10),
    .table td:nth-child(11) {
    text-align: right;
}

</style>
{% endblock %}