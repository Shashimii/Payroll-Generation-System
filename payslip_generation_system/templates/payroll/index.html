{% extends "includes/layout.html" %}
{% block title %}Payroll{% endblock title %}
{% block layout_content %}

<div class="card card-outline card-success">
  <div class="card-header">
    <h3 class="card-title mb-0">Payroll | Make Adjustments</h3>
    <div class="card-tools">
      <button type="button" class="btn btn-tool" data-card-widget="collapse">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>

  <div class="card-body">
    <p class="text-muted mb-4">
      Generate payroll summary templates by selecting the cutoff period, month, year.
    </p>

    <form id="generateBatchForm" class="row">
      <div class="form-group col-md-4">
        <label for="cutoff">Cutoff Period</label>
        <select id="cutoff" name="cutoff" class="form-control" required>
          <option value="1st">1st</option>
          <option value="2nd">2nd</option>
        </select>
      </div>

      <div class="form-group col-md-4">
        <label for="month">Payroll Month</label>
        <select id="month" name="month" class="form-control" required>
          {% for month in months %}
            <option value="{{ month }}">{{ month }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group col-md-4">
        <label for="year">Payroll Year</label>
        <select id="year" name="year" class="form-control" required>
          {% for year in years %}
            <option value="{{ year }}">{{ year }}</option>
          {% endfor %}
        </select>
      </div>
    </form>
  </div>

  <div class="card-footer text-right">
    <button type="submit" form="generateBatchForm" class="btn btn-success" onclick="submitGenerateForm">
      <i class="fas fa-plus-circle mr-1"></i> Generate Payroll Summary Templates
    </button>
  </div>
</div>

<div class="card card-outline card-success">
    <div class="card-header">
        <h3 class="card-title mb-0">Payroll | Summary Templates</h3>
        <div class="card-tools row g-2 align-items-center">
            
            <div class="col-auto">
                <select id="cutoff_month" class="form-control" name="cutoff_month">
                    <option selected disabled>Month</option>
                    {% for month in months %}
                    <option value="{{ month }}">{{ month }}</option>
                    {% endfor %}
                </select>
                </div>

            <div class="col-auto">
                <select id="cutoff_year" class="form-control" name="cutoff_year">
                    <option selected disabled>Year</option>
                    {% for year in years %}
                    <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-auto">
                <select id="cutoff" class="form-control" name="cutoff">
                    <option selected disabled>Cutoff Period</option>
                    <option value="1st">1st Period</option>
                    <option value="1st">2nd Period</option>
                </select>
            </div>

            <div class="col-auto">
                <select id="batch_number" class="form-control" name="batch_number">
                    <option selected disabled>Batch Number</option>
                    {% for b in batches %}
                    <option value="{{ b }}">Batch {{ b }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>
    </div>

  <div class="card-body">
    <table>
        <thead>
            <tr>
                <th>Employee No.</th>
                <th>Full Name</th>
                <th>Position</th>
                <th>Division</th>
            </tr>
        </thead>
        <tbody id="batchTableBody">
            <!-- AJAX data goes here -->
        </tbody>
    </table>

  </div>

  <div class="card-footer text-right">
    <button type="submit" form="generateBatchForm" class="btn btn-success" onclick="submitGenerateForm">
      <i class="fas fa-plus-circle mr-1"></i> Submit Adjustments
    </button>
  </div>
</div>

<script>
$('#generateBatchForm').on('submit', function (e) {
    e.preventDefault();

    const data = {
        cutoff: $('#cutoff').val(),
        cutoff_month: $('#month').val(),
        cutoff_year: $('#year').val(),
        csrfmiddlewaretoken: '{{ csrf_token }}'
    };

    $.ajax({
        type: 'POST',
        url: '{% url "payroll_batch_create" %}',
        data: data,
        success: function (response) {
            $('#response').html('<p style="color: green;">' + response.message + '</p>');
        },
        error: function (xhr) {
            $('#response').html('<p style="color: red;">' + xhr.responseJSON.error + '</p>');
        }
    });
});

function submitGenerateForm() {
  $('#generateBatchForm').submit();
}

$('#batch_number').on('change', function () {
    const batchNumber = $('#batch_number').val();
    const cutoff = $('#cutoff').val();
    const cutoffMonth = $('#cutoff_month').val();
    const cutoffYear = $('#cutoff_year').val();

    $.ajax({
        url: '{% url "payroll_batch_data" %}', 
        method: 'GET',
        data: {
            batch_number: batchNumber,
            cutoff: cutoff,
            cutoff_month: cutoffMonth,
            cutoff_year: cutoffYear,
        },
        success: function (response) {
            const tbody = $('#batchTableBody');
            tbody.empty();

            if (response.employees.length > 0) {
                response.employees.forEach(emp => {
                    tbody.append(`
                        <tr>
                            <td>${emp.employee_number}</td>
                            <td>${emp.fullname}</td>
                            <td>${emp.position}</td>
                            <td>${emp.division}</td>
                        </tr>
                    `);
                });
            } else {
                tbody.html('<tr><td colspan="4" class="text-muted">No employees found for this batch.</td></tr>');
            }
        },
        error: function () {
            alert('Error loading employees.');
        }
    });
});

</script>

<style>
    table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    thead {
        background-color: #f1f1f1;
        font-weight: bold;
    }

    th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
    }

    tr:nth-child(even) {
        background-color: #fafafa;
    }

    tr:hover {
        background-color: #e6f7ff;
    }
</style>
{% endblock %}