{% extends "includes/layout.html" %}
{% block title %}Payroll{% endblock title %}
{% block layout_content %}

<div class="card card-outline card-success">
  <div class="card-header">
      <h3 class="card-title mb-0">Payroll | Summary Templates</h3>
      <div class="card-tools row g-2 align-items-center">
          <div class="col-auto">
              <select id="cutoff_month" class="form-control" name="cutoff_month">
                  <option selected disabled>Month</option>
                  {% for month in months %}
                  <option value="{{ month }}">{{ month }}</option>
                  {% endfor %}
              </select>
              </div>

          <div class="col-auto">
              <select id="cutoff_year" class="form-control" name="cutoff_year">
                  <option selected disabled>Year</option>
                  {% for year in years %}
                  <option value="{{ year }}">{{ year }}</option>
                  {% endfor %}
              </select>
          </div>

          <div class="col-auto">
              <select id="cutoff_period" class="form-control" name="cutoff_period">
                  <option selected disabled>Cutoff Period</option>
                  <option value="1st">1st Period</option>
                  <option value="2nd">2nd Period</option>
              </select>
          </div>

          <div class="col-auto">
              <select id="batch_number" class="form-control" name="batch_number">
                  <option selected disabled>Batch</option>
                  {% for b in batches %}
                  <option value="{{ b.batch_number }}">{{ b.batch_name }} (#{% if b.batch_number %}{{ b.batch_number }}{% endif %})</option>
                  {% endfor %}
              </select>
          </div>
      </div>
  </div>

  <div class="card-body">
    <div style="display:flex; justify-content:space-between;">
      <div id="removeBatchBtn"></div>
      <div>
        <h2 id="payrollTitle">General Payroll DENR-NCR</h2>
        <h5 style="text-align: right;" id="payrollCutoffInfo" class="text-muted"></h5>
      </div>
  </div>
      <div id="payrollRemarkContainer" class="mb-3"></div>
      <table class="table table-striped table-bordered mt-3 text-sm">
          <thead class="table-dark text-center align-middle">
            <tr>
                <th>Seq No.</th>
                <th>Employee No.</th>
                <th>Full Name</th>
                <th>Position</th>
                <th>Salary</th>
                <th>With Sworn Declaration ?</th>
                <th>Adjusted Made ?</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="batchTableBody">
            <!-- AJAX data goes here -->
        </tbody>
    </table>

  </div>

  <div class="card-footer text-right" id="payrollSubmitBtnContainer">

  </div>
</div>

<button id="exportExcelBtn" class="btn btn-primary btn-block">
    <i class="fa-solid fa-file-excel"></i>
    Export to Excel (Beta)
</button>

{% comment %} 
<div class="card card-outline card-success collapsed-card">
  <div class="card-header">
    <h3 class="card-title mb-0">Payroll | Removed Employees</h3>
    <div class="card-tools">
      <button type="button" class="btn btn-tool" data-card-widget="collapse">
        <i class="fas fa-minus"></i>
      </button>
    </div>
  </div>

  <div class="card-body">
    <table class="table table-striped table-bordered mt-3 text-sm">
        <thead class="table-dark text-center align-middle">
          <tr>
              <th>Seq No.</th>
              <th>Employee No.</th>
              <th>Full Name</th>
              <th>Position</th>
              <th>Salary</th>
              <th>With Sworn Declaration ?</th>
              <th>Action</th>
          </tr>
      </thead>
      <tbody id="removedTableBody">
          <!-- AJAX data goes here -->
      </tbody>
    </table>
  </div>
</div> {% endcomment %}


<!-- Modal -->
<div class="modal fade" id="showAdjustmentModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Employee Payroll Adjustments</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

        <div class="card card-outline card-success">
          <div class="card-header">
            <h3 class="card-title mb-0">Make Adjustments | Employee information</h3>
          </div>
          <div class="card-body">
              <div class="mb-3">
                  <strong>Name:</strong> 
                  <span class="modalFullname"></span>
              </div>
              <div class="mb-3">
                  <strong>Position:</strong> 
                  <span class="modalPosition"></span>
              </div>
              <div>
                  <strong>Salary:</strong>
                  <span class="text-success font-weight-bold modalSalary">₱</span>
              </div>
              <input type="hidden" id="modalShowAdjustmentCutoff">
              <input type="hidden" id="modalShowAdjustmentCutoffMonth">
              <input type="hidden" id="modalShowAdjustmentCutoffYear">
              <input type="hidden" id="modalShowAdjustmentBatchNumber">
              <input type="hidden" id="modalShowAdjustmentEmployeeId">
          </div>
        </div>
        
        <div class="card card-outline card-success">
          <div class="card-header">
            <h3 class="card-title mb-0">Make Adjustments | Adjustments Made</h3>
            <div class="card-tools">
              <p><strong>Adjustments For:</strong> <span class="modalCutoff"></span></p>
            </div>
          </div>
                  <div class="card-body">
          <div id="adjustmentsContainer">
            <!-- Adjustments for this employee Here -->
          </div>
        </div>
            <div class="card-footer">
               <div class="row">
                 <div class="col-12">
                   <div class="d-flex flex-wrap justify-content-between gap-2">
                     <button id="addAdjLateRowBtn" class="btn btn-warning flex-fill">Add Late</button>
                     <button id="addAdjAbsentRowBtn" class="btn btn-danger flex-fill">Add Absent</button>
                     {% comment %} <button id="addAdjPhilhealthRowBtn" class="btn btn-primary flex-fill">Add Philhealth</button> {% endcomment %}
                     <button id="addAdjSSSRowBtn" class="btn btn-info flex-fill">Add SSS</button>
                     {% comment %} <button id="addAdjTAXRowBtn" class="btn btn-secondary flex-fill">Add TAX</button> {% endcomment %}
                     <button id="addAdjDeductionRowBtn" class="btn btn-outline-danger flex-fill">Add Deduction</button>
                     <button id="addAdjIncomeRowBtn" class="btn btn-success flex-fill">Add Income</button>
                   </div>
                 </div>
               </div>
            <div class="row mt-3">
              <div class="col-12">
                <button class="btn btn-primary w-100" id="saveAdjustmentsBtn">Save Adjustments</button>
                <button class="btn btn-secondary w-100 mt-2" data-bs-dismiss="modal">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Move Employee -->
<div class="modal fade" id="setBatchModal" tabindex="-1" role="dialog" aria-labelledby="setBatchModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setBatchModalLabel">Set Employee Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="setBatchForm">
                    <div class="form-group">
                        <label for="moveEmployeeBatchName">Employee Name:</label>
                        <input type="text" class="form-control" id="moveEmployeeBatchName" readonly>
                    </div>
                    <div class="form-group mt-3">
                        <label for="moveEmployeeBatchSelect">Select Batch:</label>
                        <select class="form-control" id="moveEmployeeBatchSelect" required>
                            <option value="">Choose a batch...</option>
                        </select>
                    </div>
                    <input type="hidden" id="moveEmployeeId">
                    <input type="hidden" id="moveEmployeeCutoff">
                    <input type="hidden" id="moveEmployeeCutoffMonth">
                    <input type="hidden" id="moveEmployeeCutoffYear">
                    <input type="hidden" id="moveEmployeeBatchNumber">
                    <input type="hidden" id="moveEmployeeAssignedOffice">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMoveEmployeeBtn">Save Batch</button>
            </div>
        </div>
    </div>
</div>

<!-- current payroll information -->
<input type="hidden" id="payrollCutoff" value="" />
<input type="hidden" id="payrollCutoffMonth" value="" />
<input type="hidden" id="payrollCutoffYear" value="" />
<input type="hidden" id="payrollBatchNumber" value="" />
<input type="hidden" id="payrollAssignedOffice" value="" />

<script>
// Money formatting function
function formatMoney(amount) {
    if (amount === null || amount === undefined || amount === '') {
        return '0.00';
    }
    const num = parseFloat(amount);
    if (isNaN(num)) {
        return '0.00';
    }
    return num.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Varaibles
let deletedAdjustmentIds = [];
let late_edit_id = null;
let absence_edit_id = null;
let philhealth_edit_id = null;
let sss_edit_id = null;
let tax_edit_id = null;

// onLoad
$(document).ready(function () {
  sessionStorageLoad();
  loadBatchData(); 
  loadRemovedEmployeeData(); 

  // Unrefactored
  $(document).on('click', '#saveAdjustmentsBtn', function () {
    const employeeId = $('#modalShowAdjustmentEmployeeId').val();

    // Reserved names that should only be used with dedicated buttons
    const reservedNames = ['late', 'absent', 'philhealth', 'sss', 'tax'];
    
    // Collect all income and deduction data from the table
    const incomes = [];
    const deductions = [];
    
    let hasReservedNameError = false;
    let reservedNameError = '';
    
    $('#adjustmentTable tbody tr').each(function() {
      const row = $(this);
      const type = row.find('.adj-type').val();
      const name = row.find('.adj-name').val();
      const amount = row.find('.adj-amount').val();
      const uniqueId = row.data('unique-id');
      
      // Check if this is a dynamic row (has unique-id) with a reserved name
      // Fixed-name rows don't have unique-id, so we only check dynamic rows
      if (uniqueId && name) {
        const nameLower = name.toLowerCase().trim();
        if (reservedNames.includes(nameLower)) {
          hasReservedNameError = true;
          reservedNameError = `"${name}" is a reserved name. Please use the dedicated "${name.charAt(0).toUpperCase() + name.slice(1)}" button instead.`;
          return false; // break the loop
        }
      }
      
      if (type === 'Income' && name && amount) {
        incomes.push({
          name: name,
          amount: amount,
          unique_id: uniqueId
        });
      } else if (type === 'Deduction' && name && amount) {
        deductions.push({
          name: name,
          amount: amount,
          unique_id: uniqueId
        });
      }
    });
    
    // Show error if reserved name was used in dynamic rows
    if (hasReservedNameError) {
      Swal.fire({
        icon: 'error',
        title: 'Invalid Name',
        text: reservedNameError,
        confirmButtonColor: '#dc3545'
      });
      return;
    }

    const data = {
      // Employee
      id: $('#modalShowAdjustmentEmployeeId').val(),
      // Absence/Late
      absence: $('#absence').val(),
      late: $('#late').val(),
      // Philhealth/SSS/TAX
      philhealth: $('#philhealth').val(),
      sss: $('#sss').val(),
      tax: $('#tax').val(),

      // Multiple Income Adjustments
      incomes: JSON.stringify(incomes),
      // Multiple Deduction Adjustments  
      deductions: JSON.stringify(deductions),

      // Cutoff info
      cutoff: $('#modalShowAdjustmentCutoff').val(),
      cutoff_month: $('#modalShowAdjustmentCutoffMonth').val(),
      cutoff_year: $('#modalShowAdjustmentCutoffYear').val(),
      batch_number: $('#modalShowAdjustmentBatchNumber').val(),

      // Deleted Adjustments id
      deleted_ids: deletedAdjustmentIds,
      // Edit Adjustments id
      late_id: late_edit_id,
      absence_id: absence_edit_id,
      philhealth_id: philhealth_edit_id,
      sss_id: sss_edit_id,
      tax_id: tax_edit_id,

      csrfmiddlewaretoken: '{{ csrf_token }}',
    };

    console.log('Sending data:', data);
    $.ajax({
      type: 'POST',
      url: `/payroll/adjustment/create/${employeeId}/`,
      data: data,
      contentType: 'application/x-www-form-urlencoded',
      success: function (response) {
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: 'Adjustment saved successfully.',
        confirmButtonColor: '#28a745'
      }).then(() => {
        location.reload();
      });
        deletedAdjustmentIds = [];
      },
      error: function (xhr) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to submit adjustment.',
          confirmButtonColor: '#dc3545'
        });
        console.log(xhr.responseText);
      }
    });
  });
})

// onSubmit
const submitGenerateForm = (btn) => {
    const month = $(btn).data('month');
    const cutoff = $(btn).data('cutoff');
    const year = $(btn).data('year');

    console.log(month, cutoff, year + 'shashimii@08092025'); // deubg - shashimii@08092025

    $.ajax({
        type: 'POST',
        url: '{% url "payroll_batch_create" %}',
        data: {
            cutoff: cutoff,
            cutoff_month: month,
            cutoff_year: year,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: response.message,
                confirmButtonColor: '#28a745'
            }).then(() => {
                location.reload();
            });
        },
        error: function (xhr) {
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: xhr.responseJSON?.error || 'Something went wrong.',
                confirmButtonColor: '#dc3545'
            });
        }
    });
};

// onChange
$('#batch_number, #cutoff_period, #cutoff_month, #cutoff_year').on('change', function () {
  sessionStorageSave();
  loadBatchData();
  loadRemovedEmployeeData();
});

// onclick
$('#exportExcelBtn').on('click', function () {
  let cutoff = $('#payrollCutoff').val();
  let cutoffMonth = $('#payrollCutoffMonth').val();
  let cutoffYear = $('#payrollCutoffYear').val();
  let batchNumber = $('#payrollBatchNumber').val();
  let assignedOffice = $('#payrollAssignedOffice').val();

  generatePayrollExcel(cutoff, cutoffMonth, cutoffYear, batchNumber, assignedOffice);
});

$(document).on('click', '.show_employee', function () {
  const employeeId = $(this).data('id');
  const cutoff = $(this).data('cutoff');
  const cutoffMonth = $(this).data('month');
  const cutoffYear = $(this).data('year');
  const batchNumber = $(this).data('batch');

  showEmployee(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber);
});

$(document).on('click', '.show_adjustments', function () {
  const employeeId = $(this).data('id');
  const cutoff = $(this).data('cutoff');
  const cutoffMonth = $(this).data('month');
  const cutoffYear = $(this).data('year');
  const batchNumber = $(this).data('batch');
  const assignedOffice = $(this).data('office');

  showAdjustment(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber, assignedOffice);
});

$(document).on('click', '.move_employees', function () {
  const employeeId = $(this).data('id');
  const employeeName = $(this).data('name');
  const cutoff = $(this).data('cutoff');
  const cutoffMonth = $(this).data('month');
  const cutoffYear = $(this).data('year');
  const batchNumber = $(this).data('batch');
  const assignedOffice = $(this).data('office');

  moveEmployee(employeeId, employeeName, cutoff, cutoffMonth, cutoffYear, batchNumber, assignedOffice);
});

$(document).on('click', '#saveMoveEmployeeBtn', function () {
  const employeeId = $(this).data('id');
  const employeeName = $(this).data('name');
  const cutoff = $(this).data('cutoff');
  const cutoffMonth = $(this).data('month');
  const cutoffYear = $(this).data('year');
  const batchNumber = $(this).data('batch');
  const assignedOffice = $(this).data('office');

  saveMoveEmployee(employeeId, employeeName, cutoff, cutoffMonth, cutoffYear, batchNumber, assignedOffice)
});


$(document).on('click', '#submitAdjustment', function () {
  const cutoff = $(this).attr('data-cutoff');
  const cutoffMonth = $(this).attr('data-month');
  const cutoffYear = $(this).attr('data-year');
  const batchNumber = $(this).attr('data-batch');
  const assignedOffice = $(this).attr('data-office');

  // submit the payroll information using ajax
  // make a url on the backend routes
  // handle the changing of the adjustment status
  // use the payroll information for selective changing

  submitPayroll(cutoff, cutoffMonth, cutoffYear, batchNumber, assignedOffice);
})

$(document).on('click', '.late_employee', function () {
  const employeeId = $(this).data('id');
  const cutoff = $(this).data('cutoff');
  const cutoffMonth = $(this).data('month');
  const cutoffYear = $(this).data('year');
  const batchNumber = $(this).data('batch');

  lateEmployee(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber);
});

$(document).on('click', '.unlate_employee', function () {
  const employeeId = $(this).data('id');
  const cutoff = $(this).data('cutoff');
  const cutoffMonth = $(this).data('month');
  const cutoffYear = $(this).data('year');
  const batchNumber = $(this).data('batch');

  unlateEmployee(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber);
});

$(document).on('click', '.remove_employee', function () {
  const employeeId = $(this).data('id');
  const cutoff = $(this).data('cutoff');
  const cutoffMonth = $(this).data('month');
  const cutoffYear = $(this).data('year');
  const batchNumber = $(this).data('batch');

  removeEmployee(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber);
});

$(document).on('click', '.unremove_employee', function () {
  const employeeId = $(this).data('id');
  const cutoff = $(this).data('cutoff');
  const cutoffMonth = $(this).data('month');
  const cutoffYear = $(this).data('year');
  const batchNumber = $(this).data('batch');

  unremoveEmployee(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber);
});

$('#addAdjLateRowBtn').on('click', () => {
  appendAdjustmentRow('Late', 'Deduction', false, 'addAdjLateRowBtn');
});

$('#addAdjAbsentRowBtn').on('click', () => {
  appendAdjustmentRow('Absent', 'Deduction', false, 'addAdjAbsentRowBtn');
});

$('#addAdjPhilhealthRowBtn').on('click', () => {
  appendAdjustmentRow('Philhealth', 'Deduction', false, 'addAdjPhilhealthRowBtn');
});

$('#addAdjSSSRowBtn').on('click', () => {
  appendAdjustmentRow('SSS', 'Deduction', false, 'addAdjSSSRowBtn');
});

$('#addAdjTAXRowBtn').on('click', () => {
  appendAdjustmentRow('TAX', 'Deduction', false, 'addAdjTAXRowBtn');
});

$('#addAdjDeductionRowBtn').on('click', () => {
  appendAdjustmentRow('Other Deduction', 'Deduction', true, 'addAdjDeductionRowBtn');
});

$('#addAdjIncomeRowBtn').on('click', () => {
  appendAdjustmentRow('Other Income', 'Income', true, 'addAdjIncomeRowBtn');
});

$(document).on('click', '.removeRowBtn', function () {
  const row = $(this).closest('tr');
  const adjustmentId = row.data('id');

  if (adjustmentId) {
    deletedAdjustmentIds.push(adjustmentId);
  }

  const buttonId = row.data('source-btn');
  if (buttonId) {
    $(`#${buttonId}`).prop('disabled', false);
  }

  row.remove();
});

// Real-time validation for reserved names in dynamic rows
$(document).on('input', '.adj-name', function() {
  const input = $(this);
  const row = input.closest('tr');
  const uniqueId = row.data('unique-id');
  
  // Only validate dynamic rows (those with unique-id)
  // Fixed-name rows don't have unique-id, so they're allowed to use reserved names
  if (uniqueId) {
    const name = input.val().toLowerCase().trim();
    const reservedNames = ['late', 'absent', 'philhealth', 'sss', 'tax'];
    
    if (reservedNames.includes(name)) {
      input.addClass('is-invalid');
      input.attr('title', `"${input.val()}" is a reserved name. Please use the dedicated button instead.`);
    } else {
      input.removeClass('is-invalid');
      input.removeAttr('title');
    }
  }
});

// Global variable to store current batch data
let currentBatchData = null;

// Function to get current batch data
function getCurrentBatchData() {
  return currentBatchData;
}

// Functions
function loadBatchData () {
  const batchNumber = $('#batch_number').val();
  const cutoff = $('#cutoff_period').val();
  const cutoffMonth = $('#cutoff_month').val();
  const cutoffYear = $('#cutoff_year').val();

  $.ajax({
      url: '{% url "payroll_batch_data" %}', 
      method: 'GET',
      data: {
          batch_number: batchNumber,
          cutoff: cutoff,
          cutoff_month: cutoffMonth,
          cutoff_year: cutoffYear,
      },
      success: function (response) {
          // Store current batch data for use in late/unlate functions
          currentBatchData = response;

          // Store current payroll information
          $('#payrollCutoff').val(response.cutoff)
          $('#payrollCutoffMonth').val(response.cutoff_month)
          $('#payrollCutoffYear').val(response.cutoff_year)
          $('#payrollBatchNumber').val(response.batch_number)
          $('#payrollAssignedOffice').val(response.assigned_office)
          
          // Update payroll title and cutoff info
          $('#payrollTitle').text(response.payroll_title || 'General Payroll DENR-NCR');
          $('#payrollCutoffInfo').text(`${response.cutoff_month} ${response.cutoff} Cutoff ${response.cutoff_year} ${response.batch_name ? '— ' + response.batch_name : 'Batch ' + response.batch_number}`);
          
          $('#submitAdjustment')
          .attr('data-cutoff', response.cutoff)
          .attr('data-month', response.cutoff_month)
          .attr('data-year', response.cutoff_year)
          .attr('data-batch', response.batch_number);

          const tbody = $('#batchTableBody');
          tbody.empty();

          if (response.employees.length > 0) {
              response.employees.forEach((emp, index) => {
                  let rowClass = '';
                  let lateButton = '';
                  let unlateButton = '';
                  let removeButton = '';
                  let unremoveButton = '';

                  if (emp.late_assigned === 'YES') {
                    rowClass = 'table-danger';
                  } else if (emp.late_assigned === 'NO') {
                    rowClass = 'table-info';
                  }

                  if (emp.late_assigned === 'YES') {
                    unlateButton = `
                      <button class='btn btn-warning btn-sm unlate_employee' 
                        data-id='${emp.id}'
                        data-cutoff='${response.cutoff}'
                        data-month='${response.cutoff_month}'
                        data-year='${response.cutoff_year}'
                        data-batch='${response.batch_number}'
                        ${(response.has_pending_adjustments || response.has_approved_adjustments || response.has_credited_adjustments || emp.previous_batch_submitted) ? 'disabled title="' + (emp.previous_batch_submitted ? 'Cannot unmark as late: Previous batch has been submitted.' : 'Adjustments are either being checked, approved, or credited.') + '"' : ''}
                      >
                        Not Late
                      </button>`;
                  } else if (emp.late_assigned === 'NO') {
                    lateButton = `
                    <button class='btn btn-warning btn-sm late_employee' 
                        data-id='${emp.id}'
                        data-cutoff='${response.cutoff}'
                        data-month='${response.cutoff_month}'
                        data-year='${response.cutoff_year}'
                        data-batch='${response.batch_number}'
                        ${(response.has_pending_adjustments || response.has_approved_adjustments || response.has_credited_adjustments) ? 'disabled title="Adjustments are either being checked, approved, or credited."' : ''}
                      >
                      Mark as Late
                    </button>`;
                  }
                  if (emp.removed === 'YES') {
                    unremoveButton = `
                      <button class='btn btn-danger btn-sm unremove_employee' 
                        data-id='${emp.id}'
                        data-cutoff='${response.cutoff}'
                        data-month='${response.cutoff_month}'
                        data-year='${response.cutoff_year}'
                        data-batch='${response.batch_number}'
                        ${(response.has_pending_adjustments || response.has_approved_adjustments || response.has_credited_adjustments || emp.previous_batch_submitted) ? 'disabled title="' + (emp.previous_batch_submitted ? 'Cannot unremove: Previous batch has been submitted.' : 'Adjustments are either being checked, approved, or credited.') + '"' : ''}
                      >
                        Unremove
                      </button>`;
                  } else if (emp.removed === 'NO' && emp.late_assigned === 'NO') {
                    removeButton = `
                    <button class='btn btn-danger btn-sm remove_employee' 
                      data-id='${emp.id}'
                      data-cutoff='${response.cutoff}'
                      data-month='${response.cutoff_month}'
                      data-year='${response.cutoff_year}'
                      data-batch='${response.batch_number}'
                      ${(response.has_pending_adjustments || response.has_approved_adjustments || response.has_credited_adjustments) ? 'disabled title="Adjustments are either being checked, approved, or credited."' : ''}
                    >
                      Remove
                    </button>`;
                  }

                  tbody.append(`
                          <tr class="${rowClass}">
                            <td>${index + 1}</td>
                            <td>${emp.employee_number}</td>
                            <td>${emp.fullname}</td>
                          <td>${emp.position}</td>
                          <td>₱ ${formatMoney(emp.salary)}</td>
                          <td>${emp.tax_declaration === 'yes' ? 'YES' : 'NO'}</td>
                            <td class="${emp.has_adjustments ? 'text-green' : 'text-red'}">${emp.has_adjustments ? 'YES' : 'NO'}</td>
                            <td>
                              <button class='btn btn-success btn-sm show_adjustments' 
                                data-id='${emp.id}'
                                data-cutoff='${response.cutoff}'
                                data-month='${response.cutoff_month}'
                                data-year='${response.cutoff_year}'
                                data-batch='${response.batch_number}'
                                data-office='${response.assigned_office || ''}'
                                ${(response.has_pending_adjustments || response.has_approved_adjustments || response.has_credited_adjustments) ? 'disabled title="Adjustments are either being checked, approved, or credited."' : ''}
                              >
                                Adjustments
                              </button>
                              <button class='btn btn-info btn-sm move_employees' 
                                data-id='${emp.id}'
                                data-name='${emp.fullname}'
                                data-cutoff='${response.cutoff}'
                                data-month='${response.cutoff_month}'
                                data-year='${response.cutoff_year}'
                                data-batch='${response.batch_number}'
                                data-office='${response.assigned_office || ''}'
                                ${(response.has_pending_adjustments || response.has_approved_adjustments || response.has_credited_adjustments) ? 'disabled title="Adjustments are either being checked, approved, or credited."' : ''}
                              >
                                Change Batch
                              </button>
                              <!---
                              ${lateButton}
                              ${unlateButton}
                              ${removeButton}
                              ${unremoveButton}
                              --->

                            </td>
                          </tr>
                      `);
                  });

                let submitButtonHtml = `
                <button class="btn btn-success" id="submitAdjustment"
                  data-cutoff="${response.cutoff}" 
                  data-month="${response.cutoff_month}" 
                  data-year="${response.cutoff_year}" 
                  data-batch="${response.batch_number}"
                  data-office="${response.assigned_office || ''}"
                  ${(response.has_pending_adjustments || response.has_approved_adjustments || response.has_credited_adjustments) ? 'disabled title="Adjustments are either being checked, approved, or credited."' : ''}
                >
                  <i class="fas fa-plus-circle mr-1"></i> Submit Adjustments
                </button>
              `;
              $('#payrollSubmitBtnContainer').html(submitButtonHtml);

              appendRemoveBatchButton(response.cutoff_month, response.cutoff, response.cutoff_year, response.assigned_office);
              if (response.has_pending_adjustments || response.has_approved_adjustments || response.has_credited_adjustments) {
                  $('#removeBatchBtn button').prop('disabled', true);
              } else {
                  $('#removeBatchBtn button').prop('disabled', false);
              }
            } else {
                $('#removeBatchBtn').empty();

                tbody.append(`
                  <tr>
                      <td colspan="8" class="text-center" style="background-color: #f8f9fa; padding: 20px;">
                          <div class="text-muted mb-3" style="font-size: 1rem; font-weight: 500;">
                              No batches found for <strong>${response.cutoff_month} ${response.cutoff} ${response.cutoff_year}</strong>.<br>
                              Please generate one or choose a different option like a different batch number.
                          </div>
                          <button 
                              type="button" 
                              class="btn btn-success" 
                              onclick="submitGenerateForm(this)"
                              data-month="${response.cutoff_month}"
                              data-cutoff="${response.cutoff}"
                              data-year="${response.cutoff_year}">
                              <i class="fas fa-plus-circle mr-1"></i> Generate Payroll Batches
                          </button>
                      </td>
                  </tr>
                `);

                $('#payrollSubmitBtnContainer').empty();
            }

          if (response.remark) {
            $('#payrollRemarkContainer').html(`
              <div class="alert alert-warning" role="alert">
                <strong>Returned Remark:</strong> ${response.remark}
              </div>
            `);
          } else if (response.approval_status) {
            $('#payrollRemarkContainer').html(`
              <div class="alert alert-success" role="alert">
                <strong>Status:</strong> ${response.approval_status}
              </div>
            `);
          } else {
            $('#payrollRemarkContainer').empty();
          }
      },
      error: function () {
          alert('Error loading employees.');
      }
  })
}

function appendRemoveBatchButton(month, cutoff, year, assignedOffice) {
    const removeBtnHTML = `
        <button 
            type="button" 
            class="btn btn-danger" 
            onclick="removeBatch(this)"
            data-month="${month}" 
            data-cutoff="${cutoff}" 
            data-year="${year}"
            data-office="${assignedOffice || ''}">
            <i class="fas fa-trash-alt mr-1"></i> Remove All Batch For the Current Payroll
        </button>
    `;
    $('#removeBatchBtn').html(removeBtnHTML);
};

function removeBatch(btn) {
    const month = $(btn).data('month');
    const cutoff = $(btn).data('cutoff');
    const year = $(btn).data('year');
    const office = $(btn).data('office');

// Map office codes to full names
const officeNames = {
    denr_ncr_nec: "DENR NCR National Ecology Center (NEC)",
    denr_ncr_prcmo: "DENR NCR PRCMO",
    meo_s: "Metropolitan Environmental Office South (MEO South)",
    meo_e: "Metropolitan Environmental Office East (MEO East)",
    meo_w: "Metropolitan Environmental Office West (MEO West)",
    meo_n: "Metropolitan Environmental Office North (MEO North)"
};

  // Get the display name or use empty string
  const officeDisplay = office && officeNames[office] ? ` for ${officeNames[office]}` : '';

  Swal.fire({
      title: 'Are you sure?',
      text: `Remove All Batches for ${month} ${cutoff}, ${year}${officeDisplay}?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, remove all batches'
  }).then((result) => {
      if (result.isConfirmed) {
          $.ajax({
              type: 'POST',
              url: '{% url "payroll_batch_delete" %}',
              data: {
                  cutoff: cutoff,
                  cutoff_month: month,
                  cutoff_year: year,
                  assigned_office: office,
                  csrfmiddlewaretoken: '{{ csrf_token }}'
              },
              success: function (response) {
                  Swal.fire({
                      icon: 'success',
                      title: 'Removed!',
                      text: response.message,
                      confirmButtonColor: '#28a745'
                  }).then(() => {
                      location.reload();
                      sessionStorageClear();
                  });
              },
              error: function (xhr) {
                  Swal.fire({
                      icon: 'error',
                      title: 'Error!',
                      text: xhr.responseJSON?.error || 'Something went wrong.',
                      confirmButtonColor: '#dc3545'
                  });
              }
          });
      }
  });
};

function showAdjustment(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber, assignedOffice) {
  // Clear removed ids first
  deletedAdjustmentIds = [];
  late_edit_id = null;
  absence_edit_id = null;
  philhealth_edit_id = null;
  sss_edit_id = null;
  tax_edit_id = null;

  // Get Employee Info
  $.ajax({
    url: `/employee/show/${employeeId}/`,
    method: 'GET',
    success: function (response) {
      const emp = response.employee;

      // Fill modal fields
      $('#modalShowAdjustmentCutoff').val(cutoff);
      $('#modalShowAdjustmentCutoffMonth').val(cutoffMonth);
      $('#modalShowAdjustmentCutoffYear').val(cutoffYear);
      $('#modalShowAdjustmentBatchNumber').val(batchNumber);
      $('#modalShowAdjustmentEmployeeId').val(employeeId);
      $('.modalFullname').text(emp.fullname);
      $('.modalPosition').text(emp.position);
      $('.modalSalary').text(emp.salary);
      $('.modalCutoff').text(`${cutoffMonth} ${cutoff} Cutoff, ${cutoffYear} — Batch ${batchNumber}`);

      // Second: Load adjustments for this employee
      $.ajax({
        url: `/payroll/adjustment/show/${employeeId}/`,
        method: 'GET',
        data: {
          cutoff: cutoff,
          cutoff_month: cutoffMonth,
          cutoff_year: cutoffYear,
          batch_number: batchNumber,
          assigned_office: assignedOffice
        },
        success: function (res) {
          const container = $('#adjustmentsContainer');
          container.empty();

          let html = `<table id="adjustmentTable" class="table table-sm table-bordered">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Value</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>`;

          if (!res.adjustments || res.adjustments.length === 0) {
            // No adjustments: Enable all buttons and show message
            $('#addAdjLateRowBtn').prop('disabled', false);
            $('#addAdjAbsentRowBtn').prop('disabled', false);
            $('#addAdjPhilhealthRowBtn').prop('disabled', false);
            $('#addAdjSSSRowBtn').prop('disabled', false);
            $('#addAdjTAXRowBtn').prop('disabled', false);
            $('#addAdjDeductionRowBtn').prop('disabled', false);
            $('#addAdjIncomeRowBtn').prop('disabled', false);
            
            // Add message row for no adjustments
            html += `<tr>
              <td colspan="4" class="text-center text-muted py-3">
                <i class="fas fa-info-circle me-2"></i>
                This Employee has no current adjustment. Add a new one or leave nothing and save it.
              </td>
            </tr>`;
          } else {
            res.adjustments.forEach(adj => {
              const name = adj.name.toLowerCase();
              const type = adj.type;
              const isLate = name === 'late';
              const isAbsent = name === 'absent';
              const isPhilhealth = name === 'philhealth';
              const isSSS = name === 'sss';
              const isTAX = name === 'tax';
              const isFixedName = isLate || isAbsent || isPhilhealth || isSSS || isTAX;

              const disableTypeSelect = true;
              const disableNameField = isFixedName;

              // Only disable buttons for Late, Absent, Philhealth, SSS, and TAX (one each)
              if (isLate) $('#addAdjLateRowBtn').prop('disabled', true);
              if (isAbsent) $('#addAdjAbsentRowBtn').prop('disabled', true);
              if (isPhilhealth) $('#addAdjPhilhealthRowBtn').prop('disabled', true);
              if (isSSS) $('#addAdjSSSRowBtn').prop('disabled', true);
              if (isTAX) $('#addAdjTAXRowBtn').prop('disabled', true);
              // Don't disable income and deduction buttons - allow multiple

              if (isLate) {
                late_edit_id = adj.id;
              } else if (isAbsent) {
                absence_edit_id = adj.id;
              } else if (isPhilhealth) {
                philhealth_edit_id = adj.id;
              } else if (isSSS) {
                sss_edit_id = adj.id;
              } else if (isTAX) {
                tax_edit_id = adj.id;
              } else {
                // For income and deduction adjustments, add them to deleted_ids
                // so they get replaced when saving
                deletedAdjustmentIds.push(adj.id);
              }

                // Generate unique ID only for dynamic adjustments (not fixed-name ones)
               let uniqueId = null;
               if (!isLate && !isAbsent && !isPhilhealth && !isSSS && !isTAX) {
                 const timestamp = Date.now();
                 const randomId = Math.random().toString(36).substr(2, 9);
                 uniqueId = `${timestamp}_${randomId}`;
               }

               // input type for name
               let inputId = '';
               if (!isLate && !isAbsent && !isPhilhealth && !isSSS && !isTAX) {
                 if (type === 'Deduction') {
                   inputId = `deduction_name_${uniqueId}`;
                 } else if (type === 'Income') {
                   inputId = `income_name_${uniqueId}`;
                 }
               }

              const inputFieldName = `
                <input type="text"
                      class="form-control form-control-sm adj-name"
                      value="${adj.name}"
                      ${disableNameField ? 'readonly' : ''}
                      ${inputId ? `id="${inputId}"` : ''}>
              `;

              // input type for minutes/day/amount
              let inputFieldMDA = '';
              if (isLate) {
                inputFieldMDA = `<div class="input-group input-group-sm">
                  <input type="number" class="form-control" id="late" value="${adj.details || ''}" placeholder="Enter minutes" title="Enter the number of minutes late">
                  <span class="input-group-text">minutes</span>
                </div>`;
              } else if (isAbsent) {
                inputFieldMDA = `<div class="input-group input-group-sm">
                  <input type="number" class="form-control" id="absence" value="${adj.details || ''}" placeholder="Enter days" title="Enter the number of days absent">
                  <span class="input-group-text">days</span>
                </div>`;
              } else if (isPhilhealth) {
                inputFieldMDA = `<div class="input-group input-group-sm">
                  <span class="input-group-text">₱</span>
                  <input type="number" class="form-control" id="philhealth" value="${parseFloat(adj.amount).toFixed(2)}" placeholder="Enter amount" title="Enter the Philhealth amount in peso">
                </div>`;
              } else if (isSSS) {
                inputFieldMDA = `<div class="input-group input-group-sm">
                  <span class="input-group-text">₱</span>
                  <input type="number" class="form-control" id="sss" value="${parseFloat(adj.amount).toFixed(2)}" placeholder="Enter amount" title="Enter the SSS amount in peso">
                </div>`;
              } else if (isTAX) {
                inputFieldMDA = `<div class="input-group input-group-sm">
                  <input type="number" class="form-control" id="tax" value="${parseFloat(adj.amount).toFixed(2)}" placeholder="Enter percentage" title="Enter the tax percentage (e.g., 15 for 15%)">
                  <span class="input-group-text">%</span>
                </div>`;
              } else if (type === 'Deduction') {
                inputFieldMDA = `<div class="input-group input-group-sm">
                  <span class="input-group-text">₱</span>
                  <input type="number" class="form-control adj-amount" id="deduction_amount_${uniqueId}" value="${parseFloat(adj.amount).toFixed(2)}" placeholder="Enter amount" title="Enter the deduction amount in peso">
                </div>`;
              } else if (type === 'Income') {
                inputFieldMDA = `<div class="input-group input-group-sm">
                  <span class="input-group-text">₱</span>
                  <input type="number" class="form-control adj-amount" id="income_amount_${uniqueId}" value="${parseFloat(adj.amount).toFixed(2)}" placeholder="Enter amount" title="Enter the income amount in peso">
                </div>`;
              }


                             html += `
                 <tr data-id="${adj.id}" data-source-btn="${
                   isLate ? 'addAdjLateRowBtn' :
                   isAbsent ? 'addAdjAbsentRowBtn' :
                   isPhilhealth ? 'addAdjPhilhealthRowBtn' :
                   isSSS ? 'addAdjSSSRowBtn' :
                   isTAX ? 'addAdjTAXRowBtn' :
                   type === 'Deduction' ? 'addAdjDeductionRowBtn' :
                   type === 'Income' ? 'addAdjIncomeRowBtn' : ''
                 }"${uniqueId ? ` data-unique-id="${uniqueId}"` : ''}>  
                  <td>
                    ${inputFieldName}
                  </td>
                  <td>
                    ${
                      disableTypeSelect
                        ? `<input type="text" class="form-control form-control-sm" value="${type}" readonly>
                          <input type="hidden" class="adj-type" value="${type}">`
                        : `<select class="form-select form-select-sm adj-type">
                            <option value="Income" ${type === 'Income' ? 'selected' : ''}>Income</option>
                            <option value="Deduction" ${type === 'Deduction' ? 'selected' : ''}>Deduction</option>
                          </select>`
                    }
                  </td>
                  <td>
                    ${inputFieldMDA}
                  </td>
                  <td>
                    <button class="btn btn-danger btn-sm removeRowBtn" type="button">Remove</button>
                  </td>
                </tr>
              `;
            });
          }

          html += `</tbody></table>`;
          container.html(html);
        },

        error: function () {
          alert('Failed to load adjustments.');
        }
      });

      // Finally, show the modal
      $('#showAdjustmentModal').modal('show');
    },
    error: function () {
      alert('Failed to load employee data.');
    }
  });
}

function moveEmployee(employeeId, employeeName, cutoff, cutoffMonth, cutoffYear, batchNumber, assignedOffice) {
  $('#setBatchModal').modal('show');
  $('#moveEmployeeBatchName').val(employeeName)
  $('#moveEmployeeId').val(employeeId)
  $('#moveEmployeeCutoff').val(cutoff)
  $('#moveEmployeeCutoffMonth').val(cutoffMonth)
  $('#moveEmployeeCutoffYear').val(cutoffYear)
  $('#moveEmployeeBatchNumber').val(batchNumber)
  $('#moveEmployeeAssignedOffice').val(assignedOffice)

  loadAvailableBatches(cutoff, cutoffMonth, cutoffYear, batchNumber);
}

function loadAvailableBatches(cutoff, cutoffMonth, cutoffYear) {
  $.ajax({
      url: '{% url "payroll_available_batches" %}',
      method: 'GET',
      data: {
          cutoff: cutoff,
          cutoff_month: cutoffMonth,
          cutoff_year: cutoffYear,
      },
      success: function(response) {
          if (response.success) {
              const batchSelect = $('#moveEmployeeBatchSelect');
              batchSelect.empty();
              batchSelect.append('<option value="">Choose a batch...</option>');
              
              response.batches.forEach(function(batch) {
                  batchSelect.append(`<option value="${batch.id}">${batch.batch_name} (#${batch.batch_number})</option>`);
              });
          } else {
              Swal.fire('Error', response.error || 'Failed to load batches', 'error');
          }
      },
      error: function() {
          Swal.fire('Error', 'Failed to load batches. Please try again.', 'error');
      }
  });
}

function saveMoveEmployee() {
  const employeeId = $('#moveEmployeeId').val();
  const cutoff = $('#moveEmployeeCutoff').val();
  const cutoffMonth = $('#moveEmployeeCutoffMonth').val();
  const cutoffYear = $('#moveEmployeeCutoffYear').val();
  const batchNumber = $('#moveEmployeeBatchNumber').val();
  const assignedOffice = $('#moveEmployeeAssignedOffice').val();
  const batchId = $('#moveEmployeeBatchSelect').val();

  if (!batchId) {
    Swal.fire('Warning', 'Please select a batch.', 'warning');
    return;
  }

  $('#saveMoveEmployeeBtn').prop('disabled', true).text('Saving...');

  $.ajax({
    url: `/payroll/move_employee/${employeeId}/`,
    method: 'POST',
    data: {
        batch_id: batchId,
        cutoff: cutoff,
        cutoff_month: cutoffMonth,
        cutoff_year: cutoffYear,
        batch_number: batchNumber,
        assigned_office: assignedOffice,
        csrfmiddlewaretoken: '{{ csrf_token }}'
    },
    success: function(response) {
        if (response.success) {
            Swal.fire({
                title: 'Success!',
                text: response.message,
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                // Close modal and refresh table
                $('#setBatchModal').modal('hide');
                loadBatchData();
            });
        } else {
            Swal.fire('Error', response.error || 'Failed to assign batch', 'error');
        }
    },
    error: function() {
        Swal.fire('Error', 'Failed to assign batch. Please try again.', 'error');
    },
    complete: function() {
        // Re-enable button
        $('#saveMoveEmployeeBtn').prop('disabled', false).text('Save Batch');
    }
});
}


// Unused function may removed in future
function lateEmployee(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber) {
  $.ajax({
    url: `/payroll/batch/late`, 
    method: 'POST',
    data: {
      employee_id: employeeId,
      cutoff: cutoff,
      cutoff_month: cutoffMonth,
      cutoff_year: cutoffYear,
      batch_number: batchNumber,
    },
    success: function (response) {
      // Check if this is the last batch to determine whether to reload or just refresh data
      const currentBatchData = getCurrentBatchData();
      const shouldReload = currentBatchData && currentBatchData.is_last_batch;
      
      Swal.fire({
        icon: 'success',
        title: 'Marked as late',
        text: 'Employee Marked as Late moved on the last batch.',
        confirmButtonColor: '#28a745'
      }).then((result) => {
        if (result.isConfirmed) {
          if (shouldReload) {
            location.reload();
          } else {
            loadBatchData();
          }
        }
      });
    },
    error: function () {
      alert('Failed to load employee data.');
    }
  });
}

function unlateEmployee(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber) {
  $.ajax({
    url: `/payroll/batch/unlate`, 
    method: 'POST',
          data: {
        employee_id: employeeId,
        cutoff: cutoff,
        cutoff_month: cutoffMonth,
        cutoff_year: cutoffYear,
        batch_number: batchNumber,
      },
    success: function (response) {
      // Check if this is the last batch to determine whether to reload or just refresh data
      const currentBatchData = getCurrentBatchData();
      const shouldReload = currentBatchData && currentBatchData.is_last_batch;
      
    Swal.fire({
      icon: 'success',
      title: 'Not Late',
      text: 'Employee moved back to its previous batch',
      confirmButtonColor: '#28a745'
    }).then((result) => {
      if (result.isConfirmed) {
        if (shouldReload) {
          location.reload();
        } else {
          loadBatchData();
        }
      }
    });
    },
    error: function () {
      alert('Failed to load employee data.');
    }
  });
}

function removeEmployee(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber) {
  $.ajax({
    url: `/payroll/batch/remove`, 
    method: 'POST',
    data: {
      employee_id: employeeId,
      cutoff: cutoff,
      cutoff_month: cutoffMonth,
      cutoff_year: cutoffYear,
      batch_number: batchNumber,
    },
    success: function (response) {
      Swal.fire({
        icon: 'success',
        title: 'Removed',
        text: 'Employee removed successfully.',
        confirmButtonColor: '#28a745'
      });
      loadBatchData();
      loadRemovedEmployeeData();
    },
    error: function () {
      alert('Failed to load employee data.');
    }
  });
}

function unremoveEmployee(employeeId, cutoff, cutoffMonth, cutoffYear, batchNumber) {
  $.ajax({
    url: `/payroll/batch/unremove`, 
    method: 'POST',
    data: {
      employee_id: employeeId,
      cutoff: cutoff,
      cutoff_month: cutoffMonth,
      cutoff_year: cutoffYear,
      batch_number: batchNumber,
    },
    success: function (response) {
    Swal.fire({
      icon: 'success',
      title: 'Restored',
      text: 'Employee moved back to its previous batch',
      confirmButtonColor: '#28a745'
    });
      loadBatchData();
      loadRemovedEmployeeData();
    },
    error: function () {
      alert('Failed to load employee data.');
    }
  });
}

function loadRemovedEmployeeData () {
  const batchNumber = $('#batch_number').val();
  const cutoff = $('#cutoff_period').val();
  const cutoffMonth = $('#cutoff_month').val();
  const cutoffYear = $('#cutoff_year').val();

  $.ajax({
      url: '{% url "payroll_removed_employee_data" %}', 
      method: 'GET',
      data: {
          batch_number: batchNumber,
          cutoff: cutoff,
          cutoff_month: cutoffMonth,
          cutoff_year: cutoffYear,
      },
      success: function (response) {

          const tbody = $('#removedTableBody');
          tbody.empty();

          if (response.employees.length > 0) {
              response.employees.forEach((emp, index) => {
                  let rowClass = '';
                  let lateButton = '';
                  let unlateButton = '';
                  let removeButton = '';
                  let unremoveButton = '';

                  if (emp.late_assigned === 'YES') {
                    rowClass = 'table-danger';
                  } else if (emp.late_assigned === 'NO') {
                    rowClass = 'table-info';
                  }

                  tbody.append(`
                      <tr class="${rowClass}">
                          <td>${index + 1}</td>
                          <td>${emp.employee_number}</td>
                          <td>${emp.fullname}</td>
                          <td>${emp.position}</td>
                          <td>₱ ${formatMoney(emp.salary)}</td>
                          <td>${emp.tax_declaration === 'yes' ? 'YES' : 'NO'}</td>
                          <td>
                            <button class='btn btn-danger btn-sm unremove_employee' 
                              data-id='${emp.id}'
                              data-cutoff='${response.cutoff}'
                              data-month='${response.cutoff_month}'
                              data-year='${response.cutoff_year}'
                              data-batch='${response.batch_number}'
                              ${(response.has_pending_adjustments || response.has_approved_adjustments || response.has_credited_adjustments || emp.previous_batch_submitted) ? 'disabled title="' + (emp.previous_batch_submitted ? 'Cannot unremove: Previous batch has been submitted.' : 'Adjustments are either being checked, approved, or credited.') + '"' : ''}
                            >
                              Unremove
                            </button>
                          </td>
                      </tr>
                  `);
              });
          } else {
              tbody.append('<tr><td colspan="8" class="text-muted text-center">Removed Employee for the Current Payroll Period will be moved here.</td></tr>');
          }
      },
      error: function () {
          alert('Error loading employees.');
      }
  })
}
// Unused function may removed in future End

function appendAdjustmentRow(name, type, isNameEditable, buttonId) {
  const isLate = name.toLowerCase() === 'late';
  const isAbsent = name.toLowerCase() === 'absent';
  const isPhilhealth = name.toLowerCase() === 'philhealth';
  const isSSS = name.toLowerCase() === 'sss';
  const isTAX = name.toLowerCase() === 'tax';
  const isFixedName = isLate || isAbsent || isPhilhealth || isSSS || isTAX;

  // Remove the "no current adjustment" message if it exists
  $('#adjustmentTable tbody tr').each(function() {
    const $row = $(this);
    const $td = $row.find('td');
    if ($td.length === 1 && $td.attr('colspan') === '4') {
      const text = $td.text().trim();
      if (text.includes('This Employee has no current adjustment')) {
        $row.remove();
      }
    }
  });

  // Generate unique IDs only for dynamic rows (not fixed-name rows)
  let uniqueId = null;
  if (!isFixedName) {
    const timestamp = Date.now();
    const randomId = Math.random().toString(36).substr(2, 9);
    uniqueId = `${timestamp}_${randomId}`;
  }

  let inputId = '';
  if (!isLate && !isAbsent && !isPhilhealth && !isSSS && !isTAX) {
    if (type === 'Deduction') {
      inputId = `deduction_name_${uniqueId}`;
    } else if (type === 'Income') {
      inputId = `income_name_${uniqueId}`;
    }
  }

  const inputFieldName = `
    <input type="text"
           class="form-control form-control-sm adj-name"
           value="${name}"
           ${isNameEditable ? '' : 'readonly'}
           ${inputId ? `id="${inputId}"` : ''}>
  `;

  let inputFieldMDA = '';
  if (isLate) {
    inputFieldMDA = `<div class="input-group input-group-sm">
      <input type="number" class="form-control" id="late" value="0" placeholder="Enter minutes" title="Enter the number of minutes late">
      <span class="input-group-text">minutes</span>
    </div>`;
  } else if (isAbsent) {
    inputFieldMDA = `<div class="input-group input-group-sm">
      <input type="number" class="form-control" id="absence" value="0" placeholder="Enter days" title="Enter the number of days absent">
      <span class="input-group-text">days</span>
    </div>`;
  } else if (isPhilhealth) {
    inputFieldMDA = `<div class="input-group input-group-sm">
      <span class="input-group-text">₱</span>
      <input type="number" class="form-control" id="philhealth" value="0" placeholder="Enter amount" title="Enter the Philhealth amount in peso">
    </div>`;
  } else if (isSSS) {
    inputFieldMDA = `<div class="input-group input-group-sm">
      <span class="input-group-text">₱</span>
      <input type="number" class="form-control" id="sss" value="0" placeholder="Enter amount" title="Enter the SSS amount in peso">
    </div>`;
  } else if (isTAX) {
    inputFieldMDA = `<div class="input-group input-group-sm">
      <input type="number" class="form-control" id="tax" value="0" placeholder="Enter percentage" title="Enter the tax percentage (e.g., 15 for 15%)">
      <span class="input-group-text">%</span>
    </div>`;
  } else if (type === 'Deduction') {
    inputFieldMDA = `<div class="input-group input-group-sm">
      <span class="input-group-text">₱</span>
      <input type="number" class="form-control adj-amount" id="deduction_amount_${uniqueId}" value="0" placeholder="Enter amount" title="Enter the deduction amount in peso">
    </div>`;
  } else if (type === 'Income') {
    inputFieldMDA = `<div class="input-group input-group-sm">
      <span class="input-group-text">₱</span>
      <input type="number" class="form-control adj-amount" id="income_amount_${uniqueId}" value="0" placeholder="Enter amount" title="Enter the income amount in peso">
    </div>`;
  }

  const typeField = `
    <input type="text" class="form-control form-control-sm" value="${type}" readonly>
    <input type="hidden" class="adj-type" value="${type}">
  `;

  const row = $(`
    <tr data-source-btn="${buttonId}"${uniqueId ? ` data-unique-id="${uniqueId}"` : ''}>
      <td>${inputFieldName}</td>
      <td>${typeField}</td>
      <td>${inputFieldMDA}</td>
      <td>
        <button class="btn btn-danger btn-sm removeRowBtn" type="button">Remove</button>
      </td>
    </tr>
  `);

  $('#adjustmentTable tbody').append(row);
  
  // Only disable buttons for Late, Absent, Philhealth, SSS, and TAX (one each)
  if (isLate || isAbsent || isPhilhealth || isSSS || isTAX) {
    $(`#${buttonId}`).prop('disabled', true);
  }
}

function submitPayroll(cutoff, cutoffMonth, cutoffYear, batchNumber, assignedOffice) {
  $.ajax({
    url: '{% url "payroll_submit" %}',
    method: 'POST',
    data: {
      batch_number: batchNumber,
      cutoff: cutoff,
      cutoff_month: cutoffMonth,
      cutoff_year: cutoffYear,
      assigned_office: assignedOffice,
    },
    success: function (response) {
      Swal.fire({
        icon: "success",
        title: "Success",
        text: response.message || "Payroll Submitted Successfully.",
      }).then(function () {
        location.reload();
      });
    },
    error: function (xhr) {
      let response = xhr.responseJSON;

      // If batch is incomplete
      if (xhr.status === 400 && response?.status === "incomplete") {
        let names = response.missing_employees.map(emp => `• ${emp.fullname}`).join('\n');
        Swal.fire({
          icon: "warning",
          title: "Incomplete Adjustments",
          html: `<p>${response.message}</p><pre style="text-align: left;">${names}</pre>`,
        });
      } else {
        // Other errors
        Swal.fire({
          icon: "error",
          title: "Error",
          text: response?.message || "An unexpected error occurred.",
        });
      }
    },
  });
}

function sessionStorageSave() {
  sessionStorage.setItem('batch_number', $('#batch_number').val());
  sessionStorage.setItem('cutoff', $('#cutoff_period').val());
  sessionStorage.setItem('cutoff_month', $('#cutoff_month').val());
  sessionStorage.setItem('cutoff_year', $('#cutoff_year').val());
}

function generatePayrollExcel(cutoff, cutoff_month, cutoff_year, batch_number, assigned_office) {
  $.ajax({
    url: "{% url 'payroll_excel_data' %}",
    method: 'POST',
    data: {
      cutoff: cutoff,
      cutoff_month: cutoff_month,
      cutoff_year: cutoff_year,
      batch_number: batch_number,
      assigned_office: assigned_office,
      csrfmiddlewaretoken: '{{ csrf_token }}',
    },
    success: async function (response) {
      try {
        // Excel File Configurations

        // Data
        const employees = response?.employees || [];

        // Workbook
        const workbook = new ExcelJS.Workbook();
        const ws = workbook.addWorksheet('GENERAL PAYROLL');
        
        // Column keys
        ws.columns = [
          { key: "seqFirst", width: 4 },
          { key: "lastName", width: 8 },
          { key: "lastNameMerged", width: 10 },
          { key: "firstName", width: 20 },
          { key: "position", width: 14 },
          { key: "monthlyRate", width: 12 },
          { key: "hasTax", width: 9 },
          { key: "salary", width: 12 },
          { key: "absence", width: 11 },
          { key: "late", width: 9 },
          { key: "adjustment", width: 11 },
          { key: "totalGross", width: 13 },
          { key: "sss", width: 12 },
          { key: "philhealthCurrent", width: 12 },
          { key: "tax", width: 12 },
          { key: "ewt", width: 12},
          { key: "philhealthPrevious", width: 12 },
          { key: "totalDeduction", width: 12 },
          { key: "netAmountDue", width: 14 },
          { key: "seqSecond", width: 4 },
          { key: "signature", width: 10 },
          { key: "signatureMerged", width: 4},
          { key: "absenceDoNot", width: 13 },
          { key: "lateDoNot", width: 13 },
          { key: "hasPhilhealth", width: 14 }
        ];

        // Full Box Border Style
        const boxBorder = {
          top: { style: "medium" },
          left: { style: "medium" },
          bottom: { style: "medium" },
          right: { style: "medium" }
        };

        // Thin line for inner grid borders; outer edges will be medium
        const thinLine = { style: 'thin' };
        const thickLine = { style: 'medium' };
        
        // General Payroll information

        // Merge
        ws.mergeCells('A1:Q1');
        ws.mergeCells('A2:Q2');
        ws.mergeCells('H3:K3');
        ws.mergeCells('A5:B5');
        ws.mergeCells('C5:G5');
        ws.mergeCells('A6:I6');
        ws.mergeCells('S6:T6');

        // Text
        ws.getCell('A1').value = "GENERAL PAYROLL";
        ws.getCell('A2').value = "DENR-NCR";
        ws.getCell('H3').value = "JULY-16-31, 2025";
        ws.getCell('A5').value = "Entity Name: ";
        ws.getCell('C5').value = "Pasig River Coordinating and Management Office - EED Cluster 2-1";
        ws.getCell('A6').value = "We acknowledge receipt of cash shown opposite our name as full compensation for services rendered for the period covered.";
        ws.getCell('S6').value = "Sheet 1 of 1";

        // Text Style
        ws.getCell('A1').font = { bold: true, size: 11 };
        ws.getCell('A2').font = { size: 11 };
        ws.getCell('H3').font = { bold: true, size: 11, underline: "single" };
        ws.getCell('A5').font = { bold: true, size: 10 }; 
        ws.getCell('C5').font = { bold: true, size: 11 };
        ws.getCell('A6').font = { size: 10 };
        ws.getCell('S6').font = { bold: true, size: 10 };

        // Text Alignment
        ws.getCell("A1").alignment = { horizontal: "center", vertical: "middle" };
        ws.getCell("A2").alignment = { horizontal: "center", vertical: "middle" };
        ws.getCell("H3").alignment = { horizontal: "center", vertical: "middle"};
        ws.getCell("A5").alignment = { horizontal: "left", vertical: "middle"};
        ws.getCell("C5").alignment = { horizontal: "left", vertical: "middle"};
        ws.getCell("A6").alignment = { horizontal: "left", vertical: "middle"};
        ws.getCell("S6").alignment = { horizontal: "right", vertical: "middle"};

        // Compress Row 7
        ws.getRow(7).height = 3;

        // Table

        // Header

        // Merge Cells
        ws.mergeCells("A8:A10");
        ws.mergeCells("B8:C10");
        ws.mergeCells("D8:D10");
        ws.mergeCells("E8:E10");
        ws.mergeCells("F8:F10");
        ws.mergeCells("G8:G10");
        ws.mergeCells("H8:H10");
        ws.mergeCells("I8:I10");
        ws.mergeCells("J8:J10");
        ws.mergeCells("K8:K10");
        ws.mergeCells("L8:L10");
        ws.mergeCells("M8:Q8");
        ws.mergeCells("M9:M10");
        ws.mergeCells("N9:N10");
        ws.mergeCells("O9:O10");
        ws.mergeCells("P9:P10");
        ws.mergeCells("Q9:Q10");
        ws.mergeCells("R8:R10");
        ws.mergeCells("S8:S10");
        ws.mergeCells("T8:T10");
        ws.mergeCells("U8:V10");
        ws.mergeCells("W8:X8");
        ws.mergeCells("W9:W10");
        ws.mergeCells("X9:X10");
        ws.mergeCells("Y8:Y10");

        // Header Height
        ws.getRow(8).height = 25;
        ws.getRow(9).height = 40;
        ws.getRow(10).height = 40;

        // Header Cells and Value
        const tableHeader = {
          A8: "Seq\nNo.",
          B8: "Last Name",
          D8: "First Name",
          E8: "Position",
          F8: "Monthly Rate",
          G8: "With Sworn Declaration? (Y/N)",
          H8: "Salaries/\nWages Earned",
          I8: "Absence",
          J8: "Late/\nUndertime",
          K8: "Adjustments from Previous Payroll if any (Over)/\nUnder Payments",
          L8: "Total Gross\nAmount Earned",
          M8: "Deductions",
          M9: "SSS PREMIUM",
          N9: "PHILHEALTH\n(CURRENT\nPAYROLL)",
          O9: "PERCENTAGE\nTAX",
          P9: "EWT",
          Q9: "PHILHEALTH\n(PREVIOUS\nPAYROLL/S)",
          R8: "Total\nDeductions",
          S8: "Net Amount Due",
          T8: "Seq\nNo.",
          U8: "Signature",
          W8: "Please DO NOT INCLUDE these\ncolumns in printing",
          W9: "Absence\n(Encode no, of\nday/s absent)",
          X9: "LATE/\nUNDERTIME (Encode no. of\nminutes of\nlate/UT)",
          Y8: "SUBJECT\nTO\nPHILHEALTH\nDEDUCTION\n(Y/N)"
        }

        // Style Header Text and Border
        Object.entries(tableHeader).forEach(([cell, value]) => {
          ws.getCell(cell).value = value;
          ws.getCell(cell).border = boxBorder;
          ws.getCell(cell).font = { bold: true, size: 9 }
          ws.getCell(cell).alignment = { horizontal: "center", vertical: "middle", wrapText: true }
        });

        // Body

        // Helper Function to split the Fullname properly
        function splitName(fullname) {
          if (!fullname) return { first: "", last: "", suffix: "" };

          let suffixes = ["JR", "SR", "III", "IV", "JR.", "SR."];

          // If there's a comma -> assume "Last, First"
          if (fullname.includes(",")) {
            let [last, firstPart] = fullname.split(",").map(s => s.trim());
            let parts = firstPart.split(" ");
            let suffix = "";

            if (suffixes.includes(parts[parts.length - 1].toUpperCase())) {
              suffix = parts.pop();
            }

            return {
              first: last,                 
              last: parts.join(" "),       
              suffix
            };
          } else {
            // Assume "First Middle Last"
            let parts = fullname.split(" ").filter(Boolean);
            let suffix = "";

            if (suffixes.includes(parts[parts.length - 1].toUpperCase())) {
              suffix = parts.pop();
            }

            let last = parts.pop() || "";
            let first = parts.join(" ");

            return {
              first: last,         
              last: first,                  
              suffix
            };
          }
        }

        // Helper capitalize
        function capitalize(str) {
          return str.replace(/\b\w/g, c => c.toUpperCase());
        }

        // Helper compute wages
        function computeWage(monthlyRate) {
          return monthlyRate / 2;
        }

        // Helper format Y/N
        function formatYN(string) {
          return (string || '').toString().toLowerCase() === 'yes' ? 'Y' : 'N';
        }
        
        // Starting Row
        let startRow = 11;

        // Employee Rows
        employees.forEach((e, index) => {
          // Holds Dynamic Row
          const rowNumber = startRow + index;
          const row = ws.getRow(rowNumber);

          // Employee Data
          const fullname = splitName(e.fullname);
          const monthlyRate = Number(e.salary ? e.salary : '');
          const wages = computeWage(monthlyRate);
          const sworn = formatYN(e.tax_declaration); 
          
          // Insert Employee Data to Row Cells
          row.getCell('A').value = index + 1;
          row.getCell('B').value = fullname.last;
          row.getCell('D').value = fullname.first;

        });

        // Merge and Add borders to Employee rows
        const totalRows = Math.max(15, employees.length); // at least 15 rows, more if employees.length > 15
        const columnsToBorder = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y'];
        const firstDataRow = startRow;
        const lastDataRow = startRow + totalRows - 1;
        const firstCol = columnsToBorder[0];
        const lastCol = columnsToBorder[columnsToBorder.length - 1];

        for (let i = 0; i < totalRows; i++) {
          const rowNumber = startRow + i;

          // Set Employee Row Height
          ws.getRow(`${rowNumber}`).height = 25;

          // Merge columns B and C for this row
          ws.mergeCells(`B${rowNumber}:C${rowNumber}`);
          ws.mergeCells(`U${rowNumber}:V${rowNumber}`);

          // Add borders thin inner grid, medium on outer box
          columnsToBorder.forEach(col => {
            const cell = ws.getCell(`${col}${rowNumber}`);
            const border = {
              top: rowNumber === firstDataRow ? { style: 'medium' } : thinLine,
              bottom: thinLine,
              left: col === firstCol ? { style: 'medium' } : thickLine,
              right: col === lastCol ? { style: 'medium' } : thickLine,
            };
            cell.border = border;
          })
        }

        // Total Row
        ws.mergeCells('A27:X28');
        ws.getRow(26).height = 8;
        ws.getRow(27).height = 11;
        ws.getRow(28).height = 11;

        [27].forEach(staticRow => {
          columnsToBorder.forEach(col => {
            const cell = ws.getCell(`${col}${staticRow}`);
            const border = {
              top: staticRow === 26 ? { style: 'medium' } : thickLine,
              bottom: staticRow === 27 ? { style: 'medium' } : thinLine,
              left: col === firstCol ? { style: 'medium' } : thinLine,
              right: col === lastCol ? { style: 'medium' } : thickLine,
            };
            cell.border = border;
          });
        });

        // Explicit rule: set left border of X26 to medium, preserve other sides
        (function() {
          const x26 = ws.getCell('X26');
          const existing = x26.border || {};
          x26.border = {
            top: existing.top,
            bottom: existing.bottom,
            left: existing.left,
            right: { style: 'medium' },
          };
        })();

        ws.getCell('Y26').border ={ right: { style: 'medium' } };

        // Explicit rules for Y27 and Y28 thick edges on totals area
        (function() {
          const y27 = ws.getCell('Y27');
          y27.border = {
            top: thickLine,
            bottom: 'none',
            left: 'none',
            right: thickLine,
          };

          const y28 = ws.getCell('Y28');
          y28.border = {
            top: 'none',
            bottom: thickLine,
            left: 'none',
            right: thickLine,
          };
        })();
        
        
        // Set Global Font
        ws.eachRow((row) => {
          row.eachCell((cell) => {
            cell.font = {
              ...cell.font,
              name: 'Aptos Narrow'     
            };
          });
        });

        // File name
        const safeOffice = (assigned_office || 'OFFICE').toString().replace(/\W+/g, '_').toUpperCase();
        const fileName = `GENERAL_PAYROLL_${safeOffice}_${cutoff_month}_${cutoff}_${cutoff_year}_BATCH_${batch_number}.xlsx`;

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        console.log(employees)
      } catch (err) {
        console.error(err);
        Swal.fire({ icon: 'error', title: 'Excel generation failed', text: 'Please try again.' });
      }
    },
    error: function () {
      alert('Failed to load adjustments.');
    }
  });
}
  
function sessionStorageLoad() {
  if (sessionStorage.getItem('batch_number')) $('#batch_number').val(sessionStorage.getItem('batch_number'));
  if (sessionStorage.getItem('cutoff')) $('#cutoff_period').val(sessionStorage.getItem('cutoff'));
  if (sessionStorage.getItem('cutoff_month')) $('#cutoff_month').val(sessionStorage.getItem('cutoff_month'));
  if (sessionStorage.getItem('cutoff_year')) $('#cutoff_year').val(sessionStorage.getItem('cutoff_year'));
}

function sessionStorageClear() {
  sessionStorage.clear();
}

</script>

<style>
    table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    thead {
        background-color: #f1f1f1;
        font-weight: bold;
    }

    th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
        font-weight:700;
    }
    
    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    
    .is-invalid:focus {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    
    /* Enhanced tooltip styling */
    input[title] {
        position: relative;
    }
    
    input[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 5px;
    }
    
    /* Placeholder styling */
    input::placeholder {
        color: #6c757d;
        font-style: italic;
        font-size: 0.875em;
    }
    
             /* Alert styling enhancement */
         .alert-info {
             border-left: 4px solid #17a2b8;
         }
         
         .alert-info .alert-heading {
             color: #0c5460;
         }
         
         /* Input group styling for inline units */
         .input-group-text {
             background-color: #f8f9fa;
             border-color: #ced4da;
             color: #495057;
             font-weight: 500;
             font-size: 0.875rem;
         }
         
         .input-group .form-control:focus + .input-group-text {
             border-color: #80bdff;
             box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
         }
         
         /* Button spacing */
         .card-footer .btn {
             margin-right: 0.5rem;
             margin-bottom: 0.5rem;
         }
   </style>
   {% endblock %}