{% extends "includes/layout.html" %}
{% block title %}Payroll{% endblock title %}
{% block layout_content %}
    <button class="btn btn-secondary mb-3" id="backBtn">
        <i class="fa-solid fa-arrow-left"></i>
        Back
    </button>


<h2 id="payrollTitle">General Payroll DENR NCR</h2>
<h4>{{ cutoff_month }} {{ cutoff }} Cutoff {{ cutoff_year }} — Batch {{ batch_number }}</h4>
<div id="payrollRemarkContainer" class="mb-3"></div>

<table class="table table-striped table-bordered mt-3 text-sm">
    <thead class="table-dark text-center align-middle">
        <tr>
            <th>#</th>
            <th>Full Name</th>
            <th>Position</th>
            <th>Salary</th>
            <th>Tax</th>
            <th>Philhealth</th>
            <th>SSS</th>
            <th>Late</th>
            <th>Absent</th>
            <th class="text-success">Adjustment Income</th>
            <th class="text-danger">Adjustment Deduction</th>
            <th>Net Pay</th>
        </tr>
        </thead>
        <tbody id="employeeTableBody">
        <tr>
            <td colspan="12" class="text-center text-muted">Loading...</td>
        </tr>
    </tbody>
</table>

<input type="hidden" id="cutoff" name="cutoff">
<input type="hidden" id="cutoff_month" name="cutoff_month">
<input type="hidden" id="batch_number" name="batch_number">
<input type="hidden" id="cutoff_year" name="cutoff_year">
<input type="hidden" id="assigned_office" name="assigned_office">

<input type="hidden" id="reject_cutoff" name="cutoff">
<input type="hidden" id="reject_cutoff_month" name="cutoff_month">
<input type="hidden" id="reject_cutoff_year" name="cutoff_year">
<input type="hidden" id="reject_batch_number" name="batch_number">
<input type="hidden" id="reject_assigned_office" name="reject_assigned_office">

<button id="approvePayrollBtn" class="btn btn-success btn-block">Approve Payroll</button>
<button class="btn btn-danger btn-block" data-bs-toggle="modal" data-bs-target="#remarksModal">
    Return Payroll with Remarks
</button>

<!-- Employee Breakdown Modal -->
<div class="modal fade" id="employeeBreakdownModal" tabindex="-1" aria-labelledby="employeeBreakdownModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="employeeBreakdownModalLabel">Employee Breakdown Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <h6 class="text-muted">Employee Information</h6>
            <p><strong>Name:</strong> <span id="modalEmployeeName"></span></p>
            <p><strong>Position:</strong> <span id="modalEmployeePosition"></span></p>
            <p><strong>Base Salary:</strong> ₱<span id="modalEmployeeSalary"></span></p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">Summary</h6>
            <p><strong>Total Income:</strong> ₱<span id="modalTotalIncome"></span></p>
            <p><strong>Total Deductions:</strong> ₱<span id="modalTotalDeductions"></span></p>
            <p><strong>Net Pay:</strong> ₱<span id="modalNetPay"></span></p>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-success">Income Breakdown</h6>
            <div id="modalIncomeBreakdown">
              <!-- Income items will be populated here -->
            </div>
          </div>
          <div class="col-md-6">
            <h6 class="text-danger">Deductions Breakdown</h6>
            <div id="modalDeductionsBreakdown">
              <!-- Deduction items will be populated here -->
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="remarksModal" tabindex="-1" aria-labelledby="remarksModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="rejectForm" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="remarksModalLabel">Return Payroll</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="cutoff" id="cutoff" value="{{ cutoff }}">
          <input type="hidden" name="cutoff_month" id="cutoff_month" value="{{ cutoff_month }}">
          <input type="hidden" name="cutoff_year" id="cutoff_year" value="{{ cutoff_year }}">
          <input type="hidden" name="batch_number" id="batch_number" value="{{ batch_number }}">
          <div class="mb-3">
            <label for="remarks" class="form-label">Remarks</label>
            <textarea class="form-control" name="remarks" id="remarks" rows="4" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Submit</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
// Money formatting function
function formatMoney(amount) {
    if (amount === null || amount === undefined || amount === '') {
        return '0.00';
    }
    const num = parseFloat(amount);
    if (isNaN(num)) {
        return '0.00';
    }
    return num.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

$(document).ready(function () {
    $('#backBtn').click(function() {
        window.location.href = "{% url 'payroll_pending' %}";
    });
    
    $.ajax({
            url: '{% url "payroll_batch_data" %}',
            method: 'GET',
            data: {
            batch_number: '{{ batch_number }}',
            cutoff: '{{ cutoff }}',
            cutoff_month: '{{ cutoff_month }}',
            cutoff_year: '{{ cutoff_year }}',
            assigned_office: '{{ assigned_office }}'
        },
        success: function (response) {
        $('#cutoff').val(response.cutoff);
        $('#cutoff_month').val(response.cutoff_month);
        $('#cutoff_year').val(response.cutoff_year);
        $('#batch_number').val(response.batch_number);
        $('#assigned_office').val(response.assigned_office);

        $('#reject_cutoff').val(response.cutoff);
        $('#reject_cutoff_month').val(response.cutoff_month);
        $('#reject_cutoff_year').val(response.cutoff_year);
        $('#reject_batch_number').val(response.batch_number);
        $('#reject_assigned_office').val(response.assigned_office);

        // Update payroll title
        $('#payrollTitle').text(response.payroll_title || 'General Payroll DENR NCR');

        // Display approval status or remarks
        if (response.remark) {
            $('#payrollRemarkContainer').html(`
                <div class="alert alert-warning" role="alert">
                    <strong>Returned Remark:</strong> ${response.remark}
                </div>
            `);
        } else if (response.approval_status) {
            $('#payrollRemarkContainer').html(`
                <div class="alert alert-success" role="alert">
                    <strong>Status:</strong> ${response.approval_status}
                </div>
            `);
        } else {
            $('#payrollRemarkContainer').empty();
        }

        const tbody = $('#employeeTableBody');
        tbody.empty();
            if (response.employees.length > 0) {
                response.employees.forEach((emp, i) => {
                const row = $(`
                    <tr class="employee-row" style="cursor: pointer;" data-employee='${JSON.stringify(emp)}' title="Click to view detailed breakdown">
                    <td>${i + 1}</td>
                    <td>${emp.fullname}</td>
                    <td>${emp.position}</td>
                    <td>₱ ${formatMoney(emp.salary)}</td>
                    <td>₱ ${formatMoney(emp.tax_deduction)}</td>
                    <td>₱ ${formatMoney(emp.philhealth)}</td>
                    <td>₱ ${formatMoney(emp.sss)}</td>
                    <td>₱ ${formatMoney(emp.late_amount)}</td>
                    <td>₱ ${formatMoney(emp.absent_amount)}</td>
                    <td>₱ ${formatMoney(emp.income)}</td>
                    <td>₱ ${formatMoney(emp.other_deductions)}</td>
                    <td>₱ ${formatMoney(emp.net_salary)}</td>
                    </tr>
                `);
                
                // Add hover effect
                row.hover(
                    function() { $(this).addClass('table-hover'); },
                    function() { $(this).removeClass('table-hover'); }
                );
                
                // Add click event
                row.click(function() {
                    showEmployeeBreakdown(emp);
                });
                
                tbody.append(row);
                });
            } else {
                tbody.append('<tr><td colspan="12" class="text-center text-muted">No employees found.</td></tr>');
            }
        },
        error: function () {
            $('#employeeTableBody').html('<tr><td colspan="12" class="text-danger text-center">Failed to load data.</td></tr>');
        }
    });

    $('#rejectForm').submit(function (e) {
        e.preventDefault();

        const formData = {
            cutoff: $('#reject_cutoff').val(),
            cutoff_month: $('#reject_cutoff_month').val(),
            cutoff_year: $('#reject_cutoff_year').val(),
            batch_number: $('#reject_batch_number').val(),
            assigned_office: $('#reject_assigned_office').val(),
            remarks: $('#remarks').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
        };

        console.log(formData) // Debug

        $.ajax({
            url: "{% url 'payroll_reject' %}",
            method: "POST",
            data: formData,
            success: function (response) {
                if (response.status === "OK") {
                    $('#remarksModal').modal('hide'); // hide the modal
                    Swal.fire({
                        icon: 'warning',
                        title: 'Returned',
                        text: 'Payroll returned with remarks.',
                        confirmButtonColor: '#ffc107'
                    }).then(() => {
                        location.href = "{% url 'payroll_pending' %}";
                    });
                }
            },
            error: function () {
                alert("Failed to return payroll. Try again.");
            }
        });
    });
});

function showEmployeeBreakdown(employee) {
    // Populate employee information
    $('#modalEmployeeName').text(employee.fullname);
    $('#modalEmployeePosition').text(employee.position);
    $('#modalEmployeeSalary').text(formatMoney(employee.salary));
    $('#modalTotalIncome').text(formatMoney(employee.income));
    $('#modalTotalDeductions').text(formatMoney(employee.total_deductions));
    $('#modalNetPay').text(formatMoney(employee.net_salary));
    
    // Populate income breakdown
    const incomeBreakdown = $('#modalIncomeBreakdown');
    incomeBreakdown.empty();
    
    if (employee.incomes && employee.incomes.length > 0) {
        employee.incomes.forEach(income => {
            const details = income.details ? ` (${income.details})` : '';
            incomeBreakdown.append(`
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <span class="text-success">${income.name}${details}</span>
                    <span class="text-success fw-bold">₱${formatMoney(income.amount)}</span>
                </div>
            `);
        });
    } else {
        incomeBreakdown.append('<p class="text-muted">No additional income</p>');
    }
    
    // Populate deductions breakdown
    const deductionsBreakdown = $('#modalDeductionsBreakdown');
    deductionsBreakdown.empty();
    
    // Add fixed deductions
    if (employee.tax_deduction && parseFloat(employee.tax_deduction) > 0) {
        deductionsBreakdown.append(`
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <span class="text-danger">TAX</span>
                <span class="text-danger fw-bold">₱${formatMoney(employee.tax_deduction)}</span>
            </div>
        `);
    }
    
    if (employee.philhealth && parseFloat(employee.philhealth) > 0) {
        deductionsBreakdown.append(`
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <span class="text-danger">Philhealth</span>
                <span class="text-danger fw-bold">₱${formatMoney(employee.philhealth)}</span>
            </div>
        `);
    }
    
    if (employee.sss && parseFloat(employee.sss) > 0) {
        deductionsBreakdown.append(`
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <span class="text-danger">SSS</span>
                <span class="text-danger fw-bold">₱${formatMoney(employee.sss)}</span>
            </div>
        `);
    }
    
    if (employee.late_amount && parseFloat(employee.late_amount) > 0) {
        const lateDetails = employee.late_minutes ? ` (${employee.late_minutes} minutes)` : '';
        deductionsBreakdown.append(`
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <span class="text-danger">Late${lateDetails}</span>
                <span class="text-danger fw-bold">₱${formatMoney(employee.late_amount)}</span>
            </div>
        `);
    }
    
    if (employee.absent_amount && parseFloat(employee.absent_amount) > 0) {
        const absentDetails = employee.absent_minutes ? ` (${employee.absent_minutes} days)` : '';
        deductionsBreakdown.append(`
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <span class="text-danger">Absent${absentDetails}</span>
                <span class="text-danger fw-bold">₱${formatMoney(employee.absent_amount)}</span>
            </div>
        `);
    }
    
    // Add dynamic deductions
    if (employee.deductions && employee.deductions.length > 0) {
        employee.deductions.forEach(deduction => {
            const details = deduction.details ? ` (${deduction.details})` : '';
            deductionsBreakdown.append(`
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <span class="text-danger">${deduction.name}${details}</span>
                    <span class="text-danger fw-bold">₱${formatMoney(deduction.amount)}</span>
                </div>
            `);
        });
    }
    
    // Show the modal
    $('#employeeBreakdownModal').modal('show');
}

$('#approvePayrollBtn').click(function () {
    let data = {
        cutoff: $('#cutoff').val(),
        cutoff_month: $('#cutoff_month').val(),
        cutoff_year: $('#cutoff_year').val(),
        batch_number: $('#batch_number').val(),
        assigned_office: $('#assigned_office').val(),
        csrfmiddlewaretoken: '{{ csrf_token }}'
    };

    console.log("Payroll approval data:", data); // Debug 

    Swal.fire({
        title: 'Approve Payroll?',
        text: "Are you sure you want to approve this payroll?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, approve it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: '{% url "payroll_approve" %}',
                method: 'POST',
                data: data,
                success: function (res) {
                    if (res.status === 'OK') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Approved!',
                            text: 'Payroll approved successfully!',
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            location.href = "{% url 'payroll_pending' %}";
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Server error.',
                        confirmButtonColor: '#d33'
                    });
                }
            });
        }
    });

    
});

</script>


<style>
table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

thead {
    background-color: #f1f1f1;
    font-weight: bold;
}

th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
    font-weight:700;
}

.table td, .table th {
    vertical-align: middle;
}

.table td:nth-child(4),
.table td:nth-child(5),
.table td:nth-child(6),
.table td:nth-child(7),
.table td:nth-child(8),
.table td:nth-child(9),
.table td:nth-child(10),
.table td:nth-child(11),
.table td:nth-child(12) {
    text-align: right;
}

/* Hover effect for clickable rows */
.employee-row:hover {
    background-color: #f8f9fa !important;
    transform: scale(1.01);
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
}

.employee-row {
    transition: all 0.2s ease;
    position: relative;
}

.employee-row::after {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: #6c757d;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.employee-row:hover::after {
    opacity: 1;
}

/* Modal styling */
.modal-lg {
    max-width: 800px;
}

.border.rounded {
    background-color: #f8f9fa;
}

.text-success {
    color: #28a745 !important;
}

.text-danger {
    color: #dc3545 !important;
}

.text-muted {
    color: #6c757d !important;
}

/* Table row styling */
.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}

/* Responsive table */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 12px;
    }
    
    .employee-row::after {
        display: none;
    }
}
</style>
{% endblock %}