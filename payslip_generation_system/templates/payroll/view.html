{% extends "includes/layout.html" %}
{% block title %}Payroll{% endblock title %}
{% block layout_content %}
    <button class="btn btn-secondary mb-3" onclick="window.location.href='{% url 'payroll_pending' %}'">
        <i class="fa-solid fa-arrow-left"></i>
        Back
    </button>


<h2>General Payroll DENR NCR</h2>
<h4>{{ cutoff_month }} {{ cutoff }} Cutoff {{ cutoff_year }} — Batch {{ batch_number }}</h4>

<table class="table table-striped table-bordered mt-3 text-sm">
    <thead class="table-dark text-center align-middle">
        <tr>
            <th>#</th>
            <th>Full Name</th>
            <th>Position</th>
            <th>Salary</th>
            <th>Tax</th>
            <th>Philhealth</th>
            <th>Late</th>
            <th>Absent</th>
            <th class="text-success">Adjustment Income</th>
            <th class="text-danger">Adjustment Deduction</th>
            <th>Net Pay</th>
        </tr>
        </thead>
        <tbody id="employeeTableBody">
        <tr>
            <td colspan="11" class="text-center text-muted">Loading...</td>
        </tr>
    </tbody>
</table>

<input type="hidden" id="cutoff" name="cutoff">
<input type="hidden" id="cutoff_month" name="cutoff_month">
<input type="hidden" id="cutoff_year" name="cutoff_year">
<input type="hidden" id="batch_number" name="batch_number">

<input type="hidden" id="reject_cutoff" name="cutoff">
<input type="hidden" id="reject_cutoff_month" name="cutoff_month">
<input type="hidden" id="reject_cutoff_year" name="cutoff_year">
<input type="hidden" id="reject_batch_number" name="batch_number">

<button id="approvePayrollBtn" class="btn btn-success btn-block">Approve Payroll</button>
<button class="btn btn-danger btn-block" data-bs-toggle="modal" data-bs-target="#remarksModal">
    Return Payroll with Remarks
</button>

<div class="modal fade" id="remarksModal" tabindex="-1" aria-labelledby="remarksModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="rejectForm" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="remarksModalLabel">Return Payroll</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="cutoff" id="cutoff" value="{{ cutoff }}">
          <input type="hidden" name="cutoff_month" id="cutoff_month" value="{{ cutoff_month }}">
          <input type="hidden" name="cutoff_year" id="cutoff_year" value="{{ cutoff_year }}">
          <input type="hidden" name="batch_number" id="batch_number" value="{{ batch_number }}">
          <div class="mb-3">
            <label for="remarks" class="form-label">Remarks</label>
            <textarea class="form-control" name="remarks" id="remarks" rows="4" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Submit</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
$(document).ready(function () {
    $.ajax({
            url: '{% url "payroll_batch_data" %}',
            method: 'GET',
            data: {
            batch_number: '{{ batch_number }}',
            cutoff: '{{ cutoff }}',
            cutoff_month: '{{ cutoff_month }}',
            cutoff_year: '{{ cutoff_year }}'
        },
        success: function (response) {
        $('#cutoff').val(response.cutoff);
        $('#cutoff_month').val(response.cutoff_month);
        $('#cutoff_year').val(response.cutoff_year);
        $('#batch_number').val(response.batch_number);

        $('#reject_cutoff').val(response.cutoff);
        $('#reject_cutoff_month').val(response.cutoff_month);
        $('#reject_cutoff_year').val(response.cutoff_year);
        $('#reject_batch_number').val(response.batch_number);

        const tbody = $('#employeeTableBody');
        tbody.empty();
            if (response.employees.length > 0) {
                response.employees.forEach((emp, i) => {
                tbody.append(`
                    <tr>
                    <td>${i + 1}</td>
                    <td>${emp.fullname}</td>
                    <td>${emp.position}</td>
                    <td>₱ ${emp.salary}</td>
                    <td>₱ ${emp.tax_deduction}</td>
                    <td>₱ ${emp.philhealth}</td>
                    <td>₱ ${emp.late_amount}</td>
                    <td>₱ ${emp.absent_amount}</td>
                    <td>₱ ${emp.income}</td>
                    <td>₱ ${emp.other_deductions}</td>
                    <td>₱ ${emp.net_salary}</td>
                    </tr>
                `);
                });
            } else {
                tbody.append('<tr><td colspan="5" class="text-center text-muted">No employees found.</td></tr>');
            }
        },
        error: function () {
            $('#employeeTableBody').html('<tr><td colspan="5" class="text-danger text-center">Failed to load data.</td></tr>');
        }
    });

    $('#rejectForm').submit(function (e) {
        e.preventDefault();

        const formData = {
            cutoff: $('#reject_cutoff').val(),
            cutoff_month: $('#reject_cutoff_month').val(),
            cutoff_year: $('#reject_cutoff_year').val(),
            batch_number: $('#reject_batch_number').val(),
            remarks: $('#remarks').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
        };

        $.ajax({
            url: "{% url 'payroll_reject' %}",
            method: "POST",
            data: formData,
            success: function (response) {
                if (response.status === "OK") {
                    $('#remarksModal').modal('hide'); // hide the modal
                    alert('Payroll returned with remarks.');
                    location.href = "{% url 'payroll_pending' %}";
                }
            },
            error: function () {
                alert("Failed to return payroll. Try again.");
            }
        });
    });
});

$('#approvePayrollBtn').click(function () {
    $.ajax({
        url: '{% url "payroll_approve" %}',
        method: 'POST',
        data: {
            cutoff: $('#cutoff').val(),
            cutoff_month: $('#cutoff_month').val(),
            cutoff_year: $('#cutoff_year').val(),
            batch_number: $('#batch_number').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}'  // required for POST
        },
        success: function (res) {
            if (res.status === 'OK') {
                alert('Payroll approved successfully!');
                location.reload();
            } else {
                alert('Failed to approve payroll.');
            }
        },
        error: function () {
            alert('Server error.');
        }
    });
});
</script>


<style>
table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

thead {
    background-color: #f1f1f1;
    font-weight: bold;
}

th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
    font-weight:700;
}


.table td, .table th {
    vertical-align: middle;
}

    .table td:nth-child(4),
    .table td:nth-child(5),
    .table td:nth-child(6),
    .table td:nth-child(7),
    .table td:nth-child(8),
    .table td:nth-child(9),
    .table td:nth-child(10),
    .table td:nth-child(11) {
    text-align: right;
}

</style>
{% endblock %}