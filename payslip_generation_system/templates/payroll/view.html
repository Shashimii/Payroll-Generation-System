{% extends "includes/layout.html" %}
{% block title %}Payroll{% endblock title %}
{% block layout_content %}
    <button class="btn btn-secondary mb-3" id="backBtn">
        <i class="fa-solid fa-arrow-left"></i>
        Back
    </button>

    {% comment %} <div class="d-flex gap-2 mb-3">
        <button id="exportExcelBtn" class="btn btn-primary">
            <i class="fa-solid fa-file-excel"></i>
            Export to Excel
        </button>
    </div> {% endcomment %}


<h2 id="payrollTitle">General Payroll DENR NCR</h2>
<h4>{{ cutoff_month }} {{ cutoff }} Cutoff {{ cutoff_year }}{% if batch_name %} — {{ batch_name }}{% else %} — Batch {{ batch_number }}{% endif %}</h4>
<div id="payrollRemarkContainer" class="mb-3"></div>

<table class="table table-striped table-bordered mt-3 text-sm">
    <thead class="table-dark text-center align-middle">
        <tr>
            <th>Seq No.</th>
            <th>Full Name</th>
            <th>Position</th>
            <th>Salary</th>
            <th>Tax</th>
            <th>Philhealth</th>
            <th>Previous Philhealth</th>
            <th>SSS</th>
            <th>Late</th>
            <th>Absent</th>
            <th class="text-success">Adjustment Income</th>
            <th class="text-danger">Adjustment Deduction</th>
            <th>Net Pay</th>
        </tr>
        </thead>
        <tbody id="employeeTableBody">
        <tr>
            <td colspan="12" class="text-center text-muted">Loading...</td>
        </tr>
    </tbody>
</table>

<input type="hidden" id="cutoff" name="cutoff">
<input type="hidden" id="cutoff_month" name="cutoff_month">
<input type="hidden" id="batch_number" name="batch_number">
<input type="hidden" id="cutoff_year" name="cutoff_year">
<input type="hidden" id="assigned_office" name="assigned_office">

<input type="hidden" id="reject_cutoff" name="cutoff">
<input type="hidden" id="reject_cutoff_month" name="cutoff_month">
<input type="hidden" id="reject_cutoff_year" name="cutoff_year">
<input type="hidden" id="reject_batch_number" name="batch_number">
<input type="hidden" id="reject_assigned_office" name="reject_assigned_office">

<button id="approvePayrollBtn" class="btn btn-success btn-block">Approve Payroll</button>
<button class="btn btn-danger btn-block" data-bs-toggle="modal" data-bs-target="#remarksModal">
    Return Payroll with Remarks
</button>

<!-- Employee Breakdown Modal -->
<div class="modal fade" id="employeeBreakdownModal" tabindex="-1" aria-labelledby="employeeBreakdownModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="employeeBreakdownModalLabel">Employee Breakdown Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <h6 class="text-muted">Employee Information</h6>
            <p><strong>Name:</strong> <span id="modalEmployeeName"></span></p>
            <p><strong>Position:</strong> <span id="modalEmployeePosition"></span></p>
            <p><strong>Base Salary:</strong> ₱<span id="modalEmployeeSalary"></span></p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">Summary</h6>
            <p><strong>Total Income:</strong> ₱<span id="modalTotalIncome"></span></p>
            <p><strong>Total Deductions:</strong> ₱<span id="modalTotalDeductions"></span></p>
            <p><strong>Net Pay:</strong> ₱<span id="modalNetPay"></span></p>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-success">Income Breakdown</h6>
            <div id="modalIncomeBreakdown">
              <!-- Income items will be populated here -->
            </div>
          </div>
          <div class="col-md-6">
            <h6 class="text-danger">Deductions Breakdown</h6>
            <div id="modalDeductionsBreakdown">
              <!-- Deduction items will be populated here -->
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="remarksModal" tabindex="-1" aria-labelledby="remarksModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="rejectForm" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="remarksModalLabel">Return Payroll</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="cutoff" id="cutoff" value="{{ cutoff }}">
          <input type="hidden" name="cutoff_month" id="cutoff_month" value="{{ cutoff_month }}">
          <input type="hidden" name="cutoff_year" id="cutoff_year" value="{{ cutoff_year }}">
          <input type="hidden" name="batch_number" id="batch_number" value="{{ batch_number }}">
          <div class="mb-3">
            <label for="remarks" class="form-label">Remarks</label>
            <textarea class="form-control" name="remarks" id="remarks" rows="4" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Submit</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
// Money formatting function
function formatMoney(amount) {
    if (amount === null || amount === undefined || amount === '') {
        return '0.00';
    }
    const num = parseFloat(amount);
    if (isNaN(num)) {
        return '0.00';
    }
    return num.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

$(document).ready(function () {
    $('#backBtn').click(function() {
        window.location.href = "{% url 'payroll_pending' %}";
    });
    
    $.ajax({
            url: '{% url "payroll_batch_data" %}',
            method: 'GET',
            data: {
            batch_number: '{{ batch_number }}',
            batch_name: '{{ batch_name }}',
            cutoff: '{{ cutoff }}',
            cutoff_month: '{{ cutoff_month }}',
            cutoff_year: '{{ cutoff_year }}',
            assigned_office: '{{ assigned_office }}'
        },
        success: function (response) {
        $('#cutoff').val(response.cutoff);
        $('#cutoff_month').val(response.cutoff_month);
        $('#cutoff_year').val(response.cutoff_year);
        $('#batch_number').val(response.batch_number);
        $('#assigned_office').val(response.assigned_office);

        $('#reject_cutoff').val(response.cutoff);
        $('#reject_cutoff_month').val(response.cutoff_month);
        $('#reject_cutoff_year').val(response.cutoff_year);
        $('#reject_batch_number').val(response.batch_number);
        $('#reject_assigned_office').val(response.assigned_office);

        // Update payroll title
        $('#payrollTitle').text(response.payroll_title || 'General Payroll DENR NCR');

        // Display approval status or remarks
        if (response.remark) {
            $('#payrollRemarkContainer').html(`
                <div class="alert alert-warning" role="alert">
                    <strong>Returned Remark:</strong> ${response.remark}
                </div>
            `);
        } else if (response.approval_status) {
            $('#payrollRemarkContainer').html(`
                <div class="alert alert-success" role="alert">
                    <strong>Status:</strong> ${response.approval_status}
                </div>
            `);
        } else {
            $('#payrollRemarkContainer').empty();
        }

        const tbody = $('#employeeTableBody');
        tbody.empty();
            if (response.employees.length > 0) {
                response.employees.forEach((emp, i) => {
                const row = $(`
                    <tr class="employee-row" style="cursor: pointer;" data-employee='${JSON.stringify(emp)}' title="Click to view detailed breakdown">
                    <td>${i + 1}</td>
                    <td>${emp.fullname}</td>
                    <td>${emp.position}</td>
                    <td>₱ ${formatMoney(emp.salary)}</td>
                    <td>₱ ${formatMoney(emp.tax_deduction)}</td>
                    <td>₱ ${formatMoney(emp.philhealth)}</td>
                    <td>₱ ${formatMoney(emp.previous_philhealth)}</td>
                    <td>₱ ${formatMoney(emp.sss)}</td>
                    <td>₱ ${formatMoney(emp.late_amount)}</td>
                    <td>₱ ${formatMoney(emp.absent_amount)}</td>
                    <td>₱ ${formatMoney(emp.income)}</td>
                    <td>₱ ${formatMoney(emp.other_deductions)}</td>
                    <td>₱ ${formatMoney(emp.net_salary)}</td>
                    </tr>
                `);
                
                // Add hover effect
                row.hover(
                    function() { $(this).addClass('table-hover'); },
                    function() { $(this).removeClass('table-hover'); }
                );
                
                // Add click event
                row.click(function() {
                    showEmployeeBreakdown(emp);
                });
                
                tbody.append(row);
                });
            } else {
                tbody.append('<tr><td colspan="12" class="text-center text-muted">No employees found.</td></tr>');
            }
        },
        error: function () {
            $('#employeeTableBody').html('<tr><td colspan="12" class="text-danger text-center">Failed to load data.</td></tr>');
        }
    });

    $('#rejectForm').submit(function (e) {
        e.preventDefault();

        const formData = {
            cutoff: $('#reject_cutoff').val(),
            cutoff_month: $('#reject_cutoff_month').val(),
            cutoff_year: $('#reject_cutoff_year').val(),
            batch_number: $('#reject_batch_number').val(),
            assigned_office: $('#reject_assigned_office').val(),
            remarks: $('#remarks').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
        };

        console.log(formData) // Debug

        $.ajax({
            url: "{% url 'payroll_reject' %}",
            method: "POST",
            data: formData,
            success: function (response) {
                if (response.status === "OK") {
                    $('#remarksModal').modal('hide'); // hide the modal
                    Swal.fire({
                        icon: 'warning',
                        title: 'Returned',
                        text: 'Payroll returned with remarks.',
                        confirmButtonColor: '#ffc107'
                    }).then(() => {
                        location.href = "{% url 'payroll_pending' %}";
                    });
                }
            },
            error: function () {
                alert("Failed to return payroll. Try again.");
            }
        });
    });
});

function showEmployeeBreakdown(employee) {
    // Populate employee information
    $('#modalEmployeeName').text(employee.fullname);
    $('#modalEmployeePosition').text(employee.position);
    $('#modalEmployeeSalary').text(formatMoney(employee.salary));
    $('#modalTotalIncome').text(formatMoney(employee.income));
    $('#modalTotalDeductions').text(formatMoney(employee.total_deductions));
    $('#modalNetPay').text(formatMoney(employee.net_salary));
    
    // Populate income breakdown
    const incomeBreakdown = $('#modalIncomeBreakdown');
    incomeBreakdown.empty();
    
    if (employee.incomes && employee.incomes.length > 0) {
        employee.incomes.forEach(income => {
            const details = income.details ? ` (${income.details})` : '';
            incomeBreakdown.append(`
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <span class="text-success">${income.name}${details}</span>
                    <span class="text-success fw-bold">₱${formatMoney(income.amount)}</span>
                </div>
            `);
        });
    } else {
        incomeBreakdown.append('<p class="text-muted">No additional income</p>');
    }
    
    // Populate deductions breakdown
    const deductionsBreakdown = $('#modalDeductionsBreakdown');
    deductionsBreakdown.empty();
    
    // Add fixed deductions
    if (employee.tax_deduction && parseFloat(employee.tax_deduction) > 0) {
        deductionsBreakdown.append(`
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <span class="text-danger">TAX</span>
                <span class="text-danger fw-bold">₱${formatMoney(employee.tax_deduction)}</span>
            </div>
        `);
    }
    
    if (employee.philhealth && parseFloat(employee.philhealth) > 0) {
        deductionsBreakdown.append(`
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <span class="text-danger">Philhealth</span>
                <span class="text-danger fw-bold">₱${formatMoney(employee.philhealth)}</span>
            </div>
        `);
    }
    
    if (employee.sss && parseFloat(employee.sss) > 0) {
        deductionsBreakdown.append(`
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <span class="text-danger">SSS</span>
                <span class="text-danger fw-bold">₱${formatMoney(employee.sss)}</span>
            </div>
        `);
    }
    
    if (employee.late_amount && parseFloat(employee.late_amount) > 0) {
        const lateDetails = employee.late_minutes ? ` (${employee.late_minutes} minutes)` : '';
        deductionsBreakdown.append(`
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <span class="text-danger">Late${lateDetails}</span>
                <span class="text-danger fw-bold">₱${formatMoney(employee.late_amount)}</span>
            </div>
        `);
    }
    
    if (employee.absent_amount && parseFloat(employee.absent_amount) > 0) {
        const absentDetails = employee.absent_minutes ? ` (${employee.absent_minutes} days)` : '';
        deductionsBreakdown.append(`
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <span class="text-danger">Absent${absentDetails}</span>
                <span class="text-danger fw-bold">₱${formatMoney(employee.absent_amount)}</span>
            </div>
        `);
    }
    
    // Add dynamic deductions
    if (employee.deductions && employee.deductions.length > 0) {
        employee.deductions.forEach(deduction => {
            const details = deduction.details ? ` (${deduction.details})` : '';
            deductionsBreakdown.append(`
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <span class="text-danger">${deduction.name}${details}</span>
                    <span class="text-danger fw-bold">₱${formatMoney(deduction.amount)}</span>
                </div>
            `);
        });
    }
    
    // Show the modal
    $('#employeeBreakdownModal').modal('show');
}

$('#approvePayrollBtn').click(function () {
    let data = {
        cutoff: $('#cutoff').val(),
        cutoff_month: $('#cutoff_month').val(),
        cutoff_year: $('#cutoff_year').val(),
        batch_number: $('#batch_number').val(),
        assigned_office: $('#assigned_office').val(),
        csrfmiddlewaretoken: '{{ csrf_token }}'
    };

    console.log("Payroll approval data:", data); // Debug 

    Swal.fire({
        title: 'Approve Payroll?',
        text: "Are you sure you want to approve this payroll?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, approve it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: '{% url "payroll_approve" %}',
                method: 'POST',
                data: data,
                success: function (res) {
                    if (res.status === 'OK') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Approved!',
                            text: 'Payroll approved successfully!',
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            location.href = "{% url 'payroll_pending' %}";
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Server error.',
                        confirmButtonColor: '#d33'
                    });
                }
            });
        }
    });

    
});

// Excel Export Functionality
$('#exportExcelBtn').click(function() {
    exportToExcel();
});

function exportToExcel() {
    // Current Cutoff Data
    const cutoff = $('#cutoff').val();
    const cutoffMonth = $('#cutoff_month').val();
    const cutoffYear = $('#cutoff_year').val();
    const batchNumber = $('#batch_number').val();
    const assignedOffice = $('#assigned_office').val();
    const payrollTitle = $('#payrollTitle').text();
    
    // Get Employee Data From the Table
    const employees = [];
    $('.employee-row').each(function() {
        const row = $(this);
        employees.push({
            sequence: row.find('td:eq(0)').text().trim(),
            fullname: row.find('td:eq(1)').text().trim(),
            position: row.find('td:eq(2)').text().trim(),
            salary: parseFloat(row.find('td:eq(3)').text().replace(/[₱,]/g, '')) || 0,
            tax: parseFloat(row.find('td:eq(4)').text().replace(/[₱,]/g, '')) || 0,
            philhealth: parseFloat(row.find('td:eq(5)').text().replace(/[₱,]/g, '')) || 0,
            sss: parseFloat(row.find('td:eq(6)').text().replace(/[₱,]/g, '')) || 0,
            late: parseFloat(row.find('td:eq(7)').text().replace(/[₱,]/g, '')) || 0,
            absent: parseFloat(row.find('td:eq(8)').text().replace(/[₱,]/g, '')) || 0,
            adjustmentIncome: parseFloat(row.find('td:eq(9)').text().replace(/[₱,]/g, '')) || 0,
            adjustmentDeduction: parseFloat(row.find('td:eq(10)').text().replace(/[₱,]/g, '')) || 0,
            netPay: parseFloat(row.find('td:eq(11)').text().replace(/[₱,]/g, '')) || 0
        });
    });

    if (employees.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'No Data',
            text: 'No employee data available to export.',
            confirmButtonColor: '#ffc107'
        });
        return;
    }

    // Create Workbook and Worksheet
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Payroll');

    // Column Width
    worksheet.columns = [
        { key: 'seqNo', width: 4 },
        { key: 'lastName', width: 15 },
        { key: 'firstName', width: 15 },
        { key: 'position', width: 20 },
        { key: 'monthlyRate', width: 15 },
        { key: 'sworn', width: 10 },
        { key: 'salariesEarned', width: 15 },
        { key: 'absence', width: 12 },
        { key: 'undertime', width: 12 },
        { key: 'adjustments', width: 15 },
        { key: 'grossAmount', width: 15 },
        { key: 'philhealthCurrent', width: 15 },
        { key: 'percentageTax', width: 15 },
        { key: 'philhealthPrevious', width: 15 },
        { key: 'totalDeductions', width: 18 },
        { key: 'netAmount', width: 18 },
        { key: 'seqNo2', width: 8 },
    ];


    // Title Rows
    worksheet.mergeCells('I1:L1');
    worksheet.getCell('I1').value = 'GENERAL PAYROLL';
    worksheet.getCell('I1').font = { bold: true, size: 14 };
    worksheet.getCell('I1').alignment = { horizontal: 'center' };

    worksheet.mergeCells('I2:L2');
    worksheet.getCell('I2').value = 'DENR-NCR';
    worksheet.getCell('I2').font = { bold: true, size: 12 };
    worksheet.getCell('I2').alignment = { horizontal: 'center' };

    worksheet.mergeCells('I3:L3');
    worksheet.getCell('I3').value = `${cutoffMonth.toUpperCase()} ${cutoff} ${cutoffYear}`;
    worksheet.getCell('I3').font = { bold: true, size: 12 };
    worksheet.getCell('I3').alignment = { horizontal: 'center' };

    // Add entity information
    worksheet.mergeCells('A5:H5');
    worksheet.getCell('A5').value = `Entity Name: ${assignedOffice.replace(/_/g, ' ').toUpperCase()}`;
    worksheet.getCell('A5').font = { bold: true };

    worksheet.mergeCells('A6:H6');
    worksheet.getCell('A6').value = 'We acknowledge receipt of cash shown opposite our name as full compensation for services rendered for the period covered.';

    worksheet.mergeCells('Q5:R5');
    worksheet.getCell('Q5').value = 'Sheet 1 of 1';

    // Table Headers

    // Merge Header Cells
    worksheet.mergeCells('A8:A10'); // Seq No.
    worksheet.mergeCells('B8:B10'); // Last Name
    worksheet.mergeCells('C8:C10'); // First Name
    worksheet.mergeCells('D8:D10'); // Position
    worksheet.mergeCells('E8:E10'); // Monthly Rate
    worksheet.mergeCells('F8:F10'); // Sworn declaration
    worksheet.mergeCells('G8:G10'); // Salaries/Wages
    worksheet.mergeCells('H8:H10'); // Absence
    worksheet.mergeCells('I8:I10'); // Late/Undertime
    worksheet.mergeCells('J8:J10'); // Income Adjustments
    worksheet.mergeCells('K8:K10'); // Deduction Adjustments

    // Header Cells Value
    const headers = {
        'A8': 'Seq No.',
        'B8': 'Last Name',
        'C8': 'First Name',
        'D8': 'Position',
        'E8': 'Monthly Rate',
        'F8': 'With Sworn Declaration (Y/N)',
        'G8': 'Salaries/Wages Earned',
        'H8': 'Absence',
        'I8': 'Late/Undertime',
        'J8': 'Income Adjustments',
        'K8': 'Deduction Adjustments'
    };

    // Apply styles and set values
    Object.keys(headers).forEach(cell => {
        const targetCell = worksheet.getCell(cell);
        targetCell.value = headers[cell];
        targetCell.font = { name: 'Aptos Narrow', size: 8, bold: true }; // size changed from 4 → 8 (4 is extremely small)
        targetCell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
    });

    // Adjust row heights for better wrapping
    worksheet.getRow(9).height = 30;
    worksheet.getRow(10).height = 30;



    /*
    worksheet.mergeCells('G8:K8');
    worksheet.getCell('G8').value = 'Salaries/Wages Earn Absence';
    worksheet.getCell('G8').alignment = { horizontal: 'center', vertical: 'middle' };
    worksheet.getCell('G8').font = { bold: true };

    // Subheaders row 9
    worksheet.getCell('G9').value = 'Salaries/Wages';
    worksheet.getCell('H9').value = 'Absence';
    worksheet.getCell('I9').value = 'Undertime';
    worksheet.getCell('J9').value = 'Adjustments';
    worksheet.getCell('K9').value = 'Gross Amount';
    
        
    // Style the sub-headers
    for (let col = 7; col <= 11; col++) {
        const cell = worksheet.getCell(9, col);
        cell.font = { bold: true, size: 10 };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
    }

    */

    // Add employee data starting from row 11
    let currentRow = 11;
    let totalSalaries = 0;
    let totalGross = 0;
    let totalPhilhealth = 0;
    let totalTax = 0;
    let totalDeductions = 0;
    let totalNet = 0;

    employees.forEach((emp, index) => {
        const row = worksheet.getRow(currentRow);
        
        // Split full name into last and first name
        const nameParts = emp.fullname.split(' ');
        const lastName = nameParts[0] || '';
        const firstName = nameParts.slice(1).join(' ') || '';

        // Calculate monthly rate (assuming salary is per cutoff, multiply by 2 for monthly)
        const monthlyRate = emp.salary * 2;
        
        // Calculate salaries earned (per cutoff)
        const salariesEarned = emp.salary;
        
        // Calculate gross amount
        const grossAmount = salariesEarned + emp.adjustmentIncome;
        
        // Calculate total deductions
        const totalDeduction = emp.tax + emp.philhealth + emp.sss + emp.late + emp.absent + emp.adjustmentDeduction;
        
        // Calculate net amount
        const netAmount = grossAmount - totalDeduction;

        row.getCell('A').value = emp.sequence;
        row.getCell('B').value = lastName;
        row.getCell('C').value = firstName;
        row.getCell('D').value = emp.position;
        row.getCell('E').value = monthlyRate;
        row.getCell('E').numFmt = '#,##0.00';
        row.getCell('F').value = 'Y'; // Default to Yes for sworn declaration
        row.getCell('G').value = salariesEarned;
        row.getCell('G').numFmt = '#,##0.00';
        row.getCell('H').value = emp.absent > 0 ? emp.absent : '-';
        row.getCell('H').numFmt = '#,##0.00';
        row.getCell('I').value = emp.late > 0 ? emp.late : '-';
        row.getCell('I').numFmt = '#,##0.00';
        row.getCell('J').value = emp.adjustmentIncome > 0 ? emp.adjustmentIncome : '-';
        row.getCell('J').numFmt = '#,##0.00';
        row.getCell('K').value = grossAmount;
        row.getCell('K').numFmt = '#,##0.00';
        row.getCell('L').value = emp.philhealth > 0 ? emp.philhealth : '-';
        row.getCell('L').numFmt = '#,##0.00';
        row.getCell('M').value = emp.tax > 0 ? emp.tax : '-';
        row.getCell('M').numFmt = '#,##0.00';
        row.getCell('N').value = '-'; // Previous payroll philhealth
        row.getCell('O').value = totalDeduction;
        row.getCell('O').numFmt = '#,##0.00';
        row.getCell('P').value = netAmount;
        row.getCell('P').numFmt = '#,##0.00';
        row.getCell('Q').value = emp.sequence;

        // Accumulate totals
        totalSalaries += salariesEarned;
        totalGross += grossAmount;
        totalPhilhealth += emp.philhealth;
        totalTax += emp.tax;
        totalDeductions += totalDeduction;
        totalNet += netAmount;

        currentRow++;
    });

    // Add totals row
    const totalRow = worksheet.getRow(currentRow);
    totalRow.font = { bold: true };
    
    worksheet.mergeCells(`A${currentRow}:F${currentRow}`);
    totalRow.getCell('A').value = 'Total';
    
    totalRow.getCell('G').value = totalSalaries;
    totalRow.getCell('G').numFmt = '#,##0.00';
    totalRow.getCell('H').value = '';
    totalRow.getCell('I').value = '';
    totalRow.getCell('J').value = '';
    totalRow.getCell('K').value = totalGross;
    totalRow.getCell('K').numFmt = '#,##0.00';
    totalRow.getCell('L').value = totalPhilhealth;
    totalRow.getCell('L').numFmt = '#,##0.00';
    totalRow.getCell('M').value = totalTax;
    totalRow.getCell('M').numFmt = '#,##0.00';
    totalRow.getCell('N').value = '';
    totalRow.getCell('O').value = totalDeductions;
    totalRow.getCell('O').numFmt = '#,##0.00';
    totalRow.getCell('P').value = totalNet;
    totalRow.getCell('P').numFmt = '#,##0.00';
    totalRow.getCell('Q').value = '';

    // Add certification sections
    const certRow = currentRow + 2;
    
    // Section A
    worksheet.mergeCells(`A${certRow}:H${certRow}`);
    worksheet.getCell(`A${certRow}`).value = 'A. CERTIFIED: Services duly rendered as stated';
    worksheet.getCell(`A${certRow}`).font = { bold: true };
    
    worksheet.mergeCells(`A${certRow + 4}:H${certRow + 4}`);
    worksheet.getCell(`A${certRow + 4}`).value = 'JAN S. BAUTISTA';
    worksheet.getCell(`A${certRow + 4}`).alignment = { horizontal: 'center' };
    
    worksheet.mergeCells(`A${certRow + 5}:H${certRow + 5}`);
    worksheet.getCell(`A${certRow + 5}`).value = 'Chief, Administrative Division';
    worksheet.getCell(`A${certRow + 5}`).alignment = { horizontal: 'center' };
    
    worksheet.mergeCells(`A${certRow + 7}:H${certRow + 7}`);
    worksheet.getCell(`A${certRow + 7}`).value = 'Date:';

    // Section B
    worksheet.mergeCells(`A${certRow + 9}:H${certRow + 9}`);
    worksheet.getCell(`A${certRow + 9}`).value = 'B. CERTIFIED: Supporting documents complete and proper, and cash available in the amount of P';
    worksheet.getCell(`A${certRow + 9}`).font = { bold: true };
    
    worksheet.mergeCells(`A${certRow + 13}:H${certRow + 13}`);
    worksheet.getCell(`A${certRow + 13}`).value = 'JAHYA M. CABAEL';
    worksheet.getCell(`A${certRow + 13}`).alignment = { horizontal: 'center' };
    
    worksheet.mergeCells(`A${certRow + 14}:H${certRow + 14}`);
    worksheet.getCell(`A${certRow + 14}`).value = 'OIC, Accounting Section';
    worksheet.getCell(`A${certRow + 14}`).alignment = { horizontal: 'center' };
    
    worksheet.mergeCells(`A${certRow + 16}:H${certRow + 16}`);
    worksheet.getCell(`A${certRow + 16}`).value = 'Date:';

    // Section C
    worksheet.mergeCells(`I${certRow}:T${certRow}`);
    worksheet.getCell(`I${certRow}`).value = 'C. APPROVED FOR PAYMENT:';
    worksheet.getCell(`I${certRow}`).font = { bold: true };
    
    worksheet.mergeCells(`I${certRow + 1}:K${certRow + 1}`);
    worksheet.getCell(`I${certRow + 1}`).value = 'Amount:';
    
    worksheet.mergeCells(`Q${certRow + 1}:T${certRow + 1}`);
    worksheet.getCell(`Q${certRow + 1}`).value = `P${totalNet.toFixed(2)}`;
    worksheet.getCell(`Q${certRow + 1}`).alignment = { horizontal: 'right' };
    
    worksheet.mergeCells(`I${certRow + 4}:T${certRow + 4}`);
    worksheet.getCell(`I${certRow + 4}`).value = 'ERLINDA O. DAQUIGAN';
    worksheet.getCell(`I${certRow + 4}`).alignment = { horizontal: 'center' };
    
    worksheet.mergeCells(`I${certRow + 5}:R${certRow + 5}`);
    worksheet.getCell(`I${certRow + 5}`).value = 'OIC, Assistant Regional Director for Management Services';
    worksheet.getCell(`I${certRow + 5}`).alignment = { horizontal: 'center' };
    
    worksheet.mergeCells(`I${certRow + 7}:R${certRow + 7}`);
    worksheet.getCell(`I${certRow + 7}`).value = 'Date:';

    // Section D
    worksheet.mergeCells(`I${certRow + 9}:P${certRow + 9}`);
    worksheet.getCell(`I${certRow + 9}`).value = 'D. CERTIFIED: Each employee whose name appears above has been paid the amount indicated opposite his/her name';
    worksheet.getCell(`I${certRow + 9}`).font = { bold: true };
    
    worksheet.mergeCells(`I${certRow + 13}:P${certRow + 13}`);
    worksheet.getCell(`I${certRow + 13}`).value = 'MYRA H. RAMOS';
    worksheet.getCell(`I${certRow + 13}`).alignment = { horizontal: 'center' };
    
    worksheet.mergeCells(`I${certRow + 14}:P${certRow + 14}`);
    worksheet.getCell(`I${certRow + 14}`).value = 'Disbursing Officer';
    worksheet.getCell(`I${certRow + 14}`).alignment = { horizontal: 'center' };
    
    worksheet.mergeCells(`I${certRow + 16}:P${certRow + 16}`);
    worksheet.getCell(`I${certRow + 16}`).value = 'Date:';

    // Section E
    worksheet.mergeCells(`Q${certRow + 9}:R${certRow + 9}`);
    worksheet.getCell(`Q${certRow + 9}`).value = 'E.';
    worksheet.getCell(`Q${certRow + 9}`).font = { bold: true };
    
    worksheet.mergeCells(`Q${certRow + 10}:R${certRow + 10}`);
    worksheet.getCell(`Q${certRow + 10}`).value = 'ORS No.:';
    
    worksheet.mergeCells(`Q${certRow + 11}:R${certRow + 11}`);
    worksheet.getCell(`Q${certRow + 11}`).value = 'Date:';
    
    worksheet.mergeCells(`Q${certRow + 12}:R${certRow + 12}`);
    worksheet.getCell(`Q${certRow + 12}`).value = 'JEV No.:';
    
    worksheet.mergeCells(`Q${certRow + 13}:R${certRow + 13}`);
    worksheet.getCell(`Q${certRow + 13}`).value = 'Date:';

    // Apply borders to the main data area
    for (let row = 8; row <= currentRow; row++) {
        for (let col = 1; col <= 18; col++) {
            const cell = worksheet.getCell(row, col);
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        }
    }

    // Generate filename
    const filename = `Payroll_${cutoffMonth}_${cutoff}_${cutoffYear}_Batch${batchNumber}.xlsx`;

    // Save the file
    workbook.xlsx.writeBuffer().then(function(buffer) {
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
        
        Swal.fire({
            icon: 'success',
            title: 'Export Successful!',
            text: `Payroll data exported to ${filename}`,
            confirmButtonColor: '#28a745'
        });
    }).catch(function(error) {
        console.error('Export error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Export Failed',
            text: 'Failed to export payroll data. Please try again.',
            confirmButtonColor: '#d33'
        });
    });
}

</script>


<style>
table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

thead {
    background-color: #f1f1f1;
    font-weight: bold;
}

th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
    font-weight:700;
}

.table td, .table th {
    vertical-align: middle;
}

.table td:nth-child(4),
.table td:nth-child(5),
.table td:nth-child(6),
.table td:nth-child(7),
.table td:nth-child(8),
.table td:nth-child(9),
.table td:nth-child(10),
.table td:nth-child(11),
.table td:nth-child(12) {
    text-align: right;
}

/* Hover effect for clickable rows */
.employee-row:hover {
    background-color: #f8f9fa !important;
    transform: scale(1.01);
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
}

.employee-row {
    transition: all 0.2s ease;
    position: relative;
}

.employee-row::after {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: #6c757d;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.employee-row:hover::after {
    opacity: 1;
}

/* Modal styling */
.modal-lg {
    max-width: 800px;
}

.border.rounded {
    background-color: #f8f9fa;
}

.text-success {
    color: #28a745 !important;
}

.text-danger {
    color: #dc3545 !important;
}

.text-muted {
    color: #6c757d !important;
}

/* Table row styling */
.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}

/* Responsive table */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 12px;
    }
    
    .employee-row::after {
        display: none;
    }
}
</style>
{% endblock %}